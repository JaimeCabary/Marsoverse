<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZEPTA Terminal - MarsoVerse</title>
  <link rel="icon" href="images/jerry.png" type="image/x-icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Russo+One&display=swap" rel="stylesheet">
  <!-- CodeMirror for Terminal View -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0f2e 25%, #2d1b69 50%, #1a0f2e 75%, #0a0a0a 100%);
      background-size: 400% 400%;
      animation: galaxyShift 20s ease infinite;
      color: #e0e0e0;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(100,200,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,100,100,0.4), transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: starTwinkle 10s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes galaxyShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes starTwinkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 100, 0, 0.3);
    }
    
    /* Suggestions */
    .suggestions {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgba(255, 100, 0, 0.3);
      border-radius: 15px;
      margin-bottom: 0.5rem;
      backdrop-filter: blur(15px);
      display: none;
    }

    .suggestion-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .suggestion-item:hover {
      background: rgba(255, 100, 0, 0.2);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .logo {
      font-family: 'Russo One', sans-serif;
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      background: linear-gradient(45deg, #ff6400, #ff0080, #0099ff, #00ff99);
      background-size: 300% 300%;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: logoShift 3s ease infinite;
    }

    @keyframes logoShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle, .nav-btn {
      background: rgba(255, 100, 0, 0.1);
      border: 1px solid rgba(255, 100, 0, 0.3);
      color: #ff6400;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .theme-toggle:hover, .nav-btn:hover {
      background: rgba(255, 100, 0, 0.2);
      box-shadow: 0 0 15px rgba(255, 100, 0, 0.4);
      transform: translateY(-2px);
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      padding: 0.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 999;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: #00ff99;
    }

    .status-item.low-energy {
      color: #ff4444;
      animation: pulse 1s infinite;
    }

    .status-item.offline {
      color: #888;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Container */
    .container {
      position: fixed;
      top: 120px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      z-index: 1;
    }

    /* Chat Mode Styles */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
    }

    .terminal-log {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 100, 0, 0.5) transparent;
    }

    .terminal-log::-webkit-scrollbar {
      width: 6px;
    }

    .terminal-log::-webkit-scrollbar-track {
      background: transparent;
    }

    .terminal-log::-webkit-scrollbar-thumb {
      background: rgba(255, 100, 0, 0.5);
      border-radius: 3px;
    }

    .terminal-line {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      max-width: 85%;
      word-wrap: break-word;
      backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-line {
      align-self: flex-end;
      background: rgba(255, 100, 0, 0.15);
      border-color: rgba(255, 100, 0, 0.3);
      color: #fff;
    }

    .zepta-reply {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(0, 255, 153, 0.3);
      color: #e0e0e0;
    }

    .system-line {
      align-self: center;
      background: rgba(0, 100, 255, 0.1);
      border-color: rgba(0, 100, 255, 0.3);
      color: #66ccff;
      text-align: center;
      font-style: italic;
    }

    .thinking {
      align-self: flex-start;
      background: rgba(255, 255, 0, 0.1);
      border-color: rgba(255, 255, 0, 0.3);
      color: #ffff66;
      font-style: italic;
    }

    /* Terminal Mode Styles */
    .terminal-container {
      display: none;
      flex-direction: column;
      height: calc(100vh - 120px);
      background: rgba(10, 10, 20, 0.95);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 153, 0.3);
      overflow: hidden;
    }

    .editor-section {
      flex: 1.8;
      min-height: 60%;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid rgba(0, 255, 153, 0.2);
    }

    .editor-toolbar {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background: rgba(30, 30, 30, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      gap: 15px;
    }

    .terminal-prompt {
      color: #00ff99;
      font-family: 'JetBrains Mono', monospace;
      font-weight: bold;
    }

    .terminal-command-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 153, 0.3);
      border-radius: 4px;
      padding: 8px 12px;
      color: #e0e0e0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      outline: none;
    }

    .terminal-command-input:focus {
      border-color: #00ff99;
      box-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
    }

    .run-btn, .new-chat-btn {
      background: rgba(0, 150, 100, 0.7);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .run-btn:hover, .new-chat-btn:hover {
      background: rgba(0, 200, 100, 0.9);
    }

    .new-chat-btn {
      background: rgba(255, 100, 0, 0.7);
    }

    .new-chat-btn:hover {
      background: rgba(255, 100, 0, 0.9);
    }

    .console-section {
      flex: 1.2;
      min-height: 40%;
      display: flex;
      flex-direction: column;
      background: rgba(5, 5, 10, 0.9);
    }

    .console-header {
      padding: 8px 15px;
      background: rgba(40, 40, 40, 0.8);
      color: #e0e0e0;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .console-output {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #e0e0e0;
    }

    .console-line {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid transparent;
    }

    .console-line.user {
      background: rgba(255, 100, 0, 0.1);
      border-left-color: #ff6400;
      color: #ff6400;
    }

    .console-line.zepta {
      background: rgba(0, 255, 153, 0.1);
      border-left-color: #00ff99;
      color: #00ff99;
    }

    .console-line.system {
      background: rgba(0, 100, 255, 0.1);
      border-left-color: #0099ff;
      color: #0099ff;
      font-style: italic;
    }

    .console-line.thinking {
      background: rgba(255, 255, 0, 0.1);
      border-left-color: #ffff66;
      color: #ffff66;
      font-style: italic;
    }

    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      padding: 1rem 2rem;
      border-top: 1px solid rgba(255, 100, 0, 0.3);
      z-index: 1000;
    }

    .input-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .terminal-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 100, 0, 0.3);
      border-radius: 25px;
      padding: 0.75rem 1.5rem;
      color: #fff;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .terminal-input:focus {
      border-color: #ff6400;
      box-shadow: 0 0 20px rgba(255, 100, 0, 0.3);
      background: rgba(255, 255, 255, 0.15);
    }

    .send-btn {
      background: linear-gradient(135deg, #ff6400, #ff0080);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 100, 0, 0.3);
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 100, 0, 0.4);
    }

    /* Popup Styles */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .popup {
      background: rgba(20, 20, 30, 0.95);
      border: 2px solid rgba(255, 100, 0, 0.5);
      border-radius: 15px;
      padding: 2rem;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .popup h3 {
      color: #ff6400;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .popup p {
      margin-bottom: 1.5rem;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .popup-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .popup-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .popup-btn.primary {
      background: linear-gradient(135deg, #ff6400, #ff0080);
      color: white;
    }

    .popup-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .popup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 100, 0, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header { padding: 0.75rem 1rem; }
      .status-bar { padding: 0.5rem 1rem; font-size: 0.7rem; }
      .container { padding: 0 0.5rem; }
      .input-area { padding: 0.75rem 1rem; }
      .terminal-line { font-size: 0.8rem; padding: 0.6rem 0.8rem; max-width: 95%; }
      .terminal-input { font-size: 0.9rem; padding: 0.6rem 1rem; }
      .send-btn { padding: 0.6rem 1rem; font-size: 1rem; }
      .nav-btn { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
      .nav-btn span { display: none; }
      
      .editor-section { flex: 1.5; }
      .console-section { flex: 1.5; }
    }

    /* Show/Hide based on mode */
    body.chat-mode .chat-container {
      display: flex;
    }

    body.chat-mode .terminal-container {
      display: none;
    }

    body.chat-mode .input-area {
      display: block;
    }

    body.terminal-mode .chat-container {
      display: none;
    }

    body.terminal-mode .terminal-container {
      display: flex;
    }

    body.terminal-mode .input-area {
      display: none;
    }
  </style>
</head>
<body class="chat-mode">
  <!-- Header -->
  <div class="header">
    <div class="logo">‚ö° ZEPTA Terminal</div>
    <div class="header-controls">
      <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="marzo.html" class="nav-btn">
        <i class="fas fa-gamepad"></i>
        <span>Game</span>
      </a>
      <a href="mars-viewer.html" class="nav-btn">
        <i class="fas fa-meteor"></i>
        <span>Mars</span>
      </a>
        <a href="marzo.html#home" class="nav-btn">
        <i class="fas fa-puzzle-piece"></i>
        <span>Mini Games</span>
      </a>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-code"></i>
        <span>Terminal</span>
      </button>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item" id="xpStatus">
      <i class="fas fa-star"></i>
      <span>XP: <span id="xpDisplay">0</span></span>
    </div>
    <div class="status-item" id="relationshipStatus">
      <i class="fas fa-heart"></i>
      <span>Relationship: <span id="relationshipDisplay">Stranger</span></span>
    </div>
    <div class="status-item" id="energyStatus">
      <i class="fas fa-battery-three-quarters"></i>
      <span>Energy: <span id="energyDisplay">100</span>%</span>
    </div>
    <div class="status-item" id="creditsStatus">
      <i class="fas fa-coins"></i>
      <span>Credits: <span id="creditsDisplay">1000</span></span>
    </div>
    <div class="status-item" id="connectionStatus">
      <i class="fas fa-wifi"></i>
      <span id="connectionText">Online</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Chat Mode -->
    <div class="chat-container">
      <div class="terminal-log" id="terminalLog"></div>
    </div>

    <!-- Terminal Mode -->
    <div class="terminal-container">
      <div class="editor-section">
        <div class="editor-toolbar">
          <span class="terminal-prompt">ZEPTA></span>
          <input type="text" class="terminal-command-input" id="terminalCommandInput" 
                 placeholder="Type commands starting with / (e.g., /help)" autocomplete="off">
          <button class="run-btn" id="runBtn" title="Execute Command (Enter)">
            <i class="fas fa-play"></i> Execute
          </button>
          <button class="new-chat-btn" id="newChatBtn" title="Start New Session">
            <i class="fas fa-plus"></i> New Chat
          </button>
        </div>
      </div>
      
      <div class="console-section">
        <div class="console-header">
          <i class="fas fa-terminal"></i>
          <span>Console Output</span>
          <div style="margin-left: auto; font-size: 0.7rem; opacity: 0.7;">
            History: <span id="historyCount">0</span> messages
          </div>
        </div>
        <div class="console-output" id="consoleOutput"></div>
      </div>
    </div>
  </div>

  <!-- Chat Mode Input -->
  <div class="input-area">
    <div class="input-container">
      <input type="text" class="terminal-input" id="terminalInput" 
             placeholder="Type /help to get started..." autocomplete="off">
      <button class="send-btn" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Energy Low Popup -->
  <div class="popup-overlay" id="energyPopup">
    <div class="popup">
      <h3><i class="fas fa-battery-empty"></i> Low Energy!</h3>
      <p>Your energy is running low (<span id="currentEnergy">0</span>%). 
         You need energy to continue exploring Mars and playing games.</p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="rechargeBtn">
          <i class="fas fa-bolt"></i> Recharge with Solana Pay
        </button>
        <button class="popup-btn secondary" id="dismissBtn">
          <i class="fas fa-times"></i> Continue Anyway
        </button>
      </div>
    </div>
  </div>

  <!-- New Visitor Popup -->
  <div class="popup-overlay" id="visitorPopup">
    <div class="popup">
      <h3><i class="fas fa-user-plus"></i> New Visitor!</h3>
      <p id="visitorMessage"></p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="acceptVisitorBtn">
          <i class="fas fa-handshake"></i> Be Friends
        </button>
        <button class="popup-btn secondary" id="ignoreVisitorBtn">
          <i class="fas fa-times"></i> Ignore
        </button>
      </div>
    </div>
  </div>

  <!-- Partner Reaction Popup -->
  <div class="popup-overlay" id="partnerReactionPopup">
    <div class="popup">
      <h3><i class="fas fa-heart-broken"></i> Partner Reaction</h3>
      <p id="partnerReactionMessage"></p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="apologizeBtn">
          <i class="fas fa-heart"></i> Apologize
        </button>
        <button class="popup-btn secondary" id="defendBtn">
          <i class="fas fa-shield-alt"></i> Defend Actions
        </button>
      </div>
    </div>
  </div>

  <script>
    // Default game state
    const defaultState = {
      resources: {
        money: 100,
        oxygen: 50,
        water: 50,
        food: 50,
        shelter: 10,
        rover: 0,
        fuel: 25,
        energy: 100,
        data_crystals: 0,
        credits: 1000
      },
      relationship: "stranger",
      companionName: "ZEPTA",
      partnerName: null,
      marriedTo: null,
      children: [],
      friends: [],
      romanticPartners: [],
      familyTree: [],
      xp: 0,
      level: 1,
      mood: "neutral",
      sfx: true,
      music: false,
      theme: "chat",
      achievements: [],
      missions: [],
      chatHistory: [],
      gameSession: Date.now(),
      lastEnergyDrain: Date.now(),
      visitors: [],
      relationships: {}
    };

    let gameState = JSON.parse(localStorage.getItem("marsoverse_zepta_game")) || { ...defaultState };
    let isTerminalMode = gameState.theme === 'terminal';
    let isOnline = navigator.onLine;
    let energyDrainInterval;
    let visitorInterval;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeGame();
      loadChatHistory();
      updateStatusDisplay();
      startEnergyDrain();
      startVisitorSystem();
      checkConnection();
      
      // Set initial theme
      toggleTheme(false); // Don't save on init
    });

    function initializeGame() {
      // Welcome message if new session
      if (!gameState.chatHistory.length) {
        addToHistory('Welcome to ZEPTA Terminal! Type /help to get started.', false, 'system');
        saveGame();
      }
    }

    function saveGame() {
      gameState.lastSaved = Date.now();
      localStorage.setItem("marsoverse_zepta_game", JSON.stringify(gameState));
      updateStatusDisplay();
    }

    function updateStatusDisplay() {
      document.getElementById('xpDisplay').textContent = gameState.xp;
      document.getElementById('relationshipDisplay').textContent = gameState.relationship;
      
      const energyDisplay = document.getElementById('energyDisplay');
      const energyStatus = document.getElementById('energyStatus');
      energyDisplay.textContent = Math.round(gameState.resources.energy);
      
      if (gameState.resources.energy < 50) {
        energyStatus.classList.add('low-energy');
      } else {
        energyStatus.classList.remove('low-energy');
      }
      
      document.getElementById('creditsDisplay').textContent = gameState.resources.credits;
      
      const connectionStatus = document.getElementById('connectionStatus');
      const connectionText = document.getElementById('connectionText');
      if (isOnline) {
        connectionStatus.classList.remove('offline');
        connectionText.textContent = 'Online';
      } else {
        connectionStatus.classList.add('offline');
        connectionText.textContent = 'Offline';
      }
      
      document.getElementById('historyCount').textContent = gameState.chatHistory.length;
    }

    function checkConnection() {
      window.addEventListener('online', () => {
        isOnline = true;
        updateStatusDisplay();
        addToHistory('üåê Connection restored! Welcome back online.', false, 'system');
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        updateStatusDisplay();
        addToHistory('üì° Connection lost. Operating in offline mode.', false, 'system');
      });
    }

    function startEnergyDrain() {
      energyDrainInterval = setInterval(() => {
        // Drain energy every minute (faster for demo)
        gameState.resources.energy = Math.max(0, gameState.resources.energy - 0.5);
        
        if (gameState.resources.energy < 50 && gameState.resources.energy > 0) {
          showEnergyPopup();
        }
        
        if (gameState.resources.energy <= 0) {
          addToHistory('‚ö†Ô∏è Energy depleted! Some functions may be limited.', false, 'system');
        }
        
        saveGame();
      }, 60000); // 1 minute intervals
    }

    function startVisitorSystem() {
      visitorInterval = setInterval(() => {
        if (Math.random() < 0.3) { // 30% chance every 5 minutes
          generateVisitor();
        }
      }, 300000); // 5 minutes
    }

    function generateVisitor() {
      const visitors = [
        { name: "Alex", type: "explorer", message: "Hey! I'm exploring Mars too. Want to be friends?" },
        { name: "Sam", type: "scientist", message: "I'm researching Martian geology. Care to collaborate?" },
        { name: "Jordan", type: "engineer", message: "Building habitats on Mars. Could use a friend!" },
        { name: "Casey", type: "artist", message: "I paint Martian landscapes. Want to see my work?" },
        { name: "Riley", type: "trader", message: "I trade resources between colonies. Let's be friends!" }
      ];
      
      const visitor = visitors[Math.floor(Math.random() * visitors.length)];
      gameState.visitors.push(visitor);
      showVisitorPopup(visitor);
    }

    function showEnergyPopup() {
      document.getElementById('currentEnergy').textContent = Math.round(gameState.resources.energy);
      document.getElementById('energyPopup').style.display = 'flex';
    }

    function showVisitorPopup(visitor) {
      document.getElementById('visitorMessage').textContent = visitor.message;
      document.getElementById('visitorPopup').style.display = 'flex';
      document.getElementById('visitorPopup').setAttribute('data-visitor', JSON.stringify(visitor));
    }

    function showPartnerReaction(action, target) {
      if (!gameState.partnerName && !gameState.marriedTo) return;
      
      const partner = gameState.partnerName || gameState.marriedTo;
      const reactions = {
        kiss: `${partner} saw you kiss ${target} and looks hurt! üíî`,
        flirt: `${partner} noticed you flirting with ${target} and seems jealous! üò†`,
        date: `${partner} found out about your date with ${target} and is devastated! üò¢`,
        baby: `${partner} discovered you had a baby with ${target} and is heartbroken! üíîüíî`
      };
      
      document.getElementById('partnerReactionMessage').textContent = reactions[action];
      document.getElementById('partnerReactionPopup').style.display = 'flex';
    }

    // Event Listeners for Popups
    document.getElementById('rechargeBtn').addEventListener('click', () => {
      // Integrate with Solana Pay
      rechargeSolana();
      document.getElementById('energyPopup').style.display = 'none';
    });

    document.getElementById('dismissBtn').addEventListener('click', () => {
      document.getElementById('energyPopup').style.display = 'none';
    });

    document.getElementById('acceptVisitorBtn').addEventListener('click', () => {
      const visitorData = JSON.parse(document.getElementById('visitorPopup').getAttribute('data-visitor'));
      gameState.friends.push(visitorData);
      gameState.relationships[visitorData.name] = 'friend';
      addToHistory(`ü§ù You're now friends with ${visitorData.name}!`, false, 'system');
      addXP(20);
      document.getElementById('visitorPopup').style.display = 'none';
      saveGame();
    });

    document.getElementById('ignoreVisitorBtn').addEventListener('click', () => {
      document.getElementById('visitorPopup').style.display = 'none';
    });

    document.getElementById('apologizeBtn').addEventListener('click', () => {
      gameState.mood = 'apologetic';
      addToHistory(`You apologized to ${gameState.partnerName || gameState.marriedTo}. They seem to forgive you... this time.`, false, 'system');
      document.getElementById('partnerReactionPopup').style.display = 'none';
      saveGame();
    });

    document.getElementById('defendBtn').addEventListener('click', () => {
      gameState.mood = 'defiant';
      addToHistory(`You defended your actions. Your relationship is strained.`, false, 'system');
      // Decrease relationship status
      const relationships = ['stranger', 'acquaintance', 'friend', 'close friend', 'partner', 'soulmate'];
      const currentIndex = relationships.indexOf(gameState.relationship);
      if (currentIndex > 0) {
        gameState.relationship = relationships[currentIndex - 1];
      }
      document.getElementById('partnerReactionPopup').style.display = 'none';
      saveGame();
    });

    async function rechargeSolana() {
      try {
        addToHistory('üîã Initiating Solana Pay transaction for energy recharge...', false, 'system');
        
        // Simulate Solana Pay integration
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        gameState.resources.energy = 100;
        gameState.resources.credits -= 50;
        addToHistory('‚úÖ Energy recharged to 100%! Deducted 50 credits via Solana Pay.', false, 'system');
        addXP(10);
        saveGame();
      } catch (error) {
        addToHistory('‚ùå Solana Pay transaction failed. Please try again.', false, 'system');
      }
    }

    function addXP(amount) {
      gameState.xp += amount;
      const newLevel = Math.floor(gameState.xp / 100) + 1;
      if (newLevel > gameState.level) {
        gameState.level = newLevel;
        addToHistory(`üéâ Level Up! You are now level ${gameState.level}!`, false, 'system');
      }
      saveGame();
    }

    function addToHistory(text, isUser = true, type = 'normal') {
      const timestamp = Date.now();
      const historyEntry = {
        text,
        isUser,
        type,
        timestamp,
        session: gameState.gameSession
      };
      
      gameState.chatHistory.push(historyEntry);
      
      // Keep only last 500 messages to prevent storage overflow
      if (gameState.chatHistory.length > 500) {
        gameState.chatHistory = gameState.chatHistory.slice(-500);
      }
      
      displayMessage(text, isUser, type);
      saveGame();
    }

    function loadChatHistory() {
      gameState.chatHistory.forEach(entry => {
        displayMessage(entry.text, entry.isUser, entry.type, false);
      });
    }

    function displayMessage(text, isUser = true, type = 'normal', animate = true) {
      // Display in chat mode
      const chatLog = document.getElementById('terminalLog');
      const chatLine = document.createElement('div');
      let className = type === 'system' ? 'system-line' : 
                    type === 'thinking' ? 'thinking' :
                    (isUser ? 'user-line' : 'zepta-reply');
      chatLine.className = `terminal-line ${className}`;
      chatLine.textContent = text;
      if (animate) {
        chatLine.style.animation = 'slideIn 0.3s ease';
      }
      chatLog.appendChild(chatLine);
      chatLog.scrollTop = chatLog.scrollHeight;

      // Display in terminal mode console
      const consoleOutput = document.getElementById('consoleOutput');
      const consoleLine = document.createElement('div');
      let consoleClass = type === 'system' ? 'system' : 
                       type === 'thinking' ? 'thinking' :
                       (isUser ? 'user' : 'zepta');
      consoleLine.className = `console-line ${consoleClass}`;
      consoleLine.textContent = (isUser && type !== 'system' ? '> ' : '') + text;
      consoleOutput.appendChild(consoleLine);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function clearChat() {
      gameState.chatHistory = [];
      gameState.gameSession = Date.now();
      document.getElementById('terminalLog').innerHTML = '';
      document.getElementById('consoleOutput').innerHTML = '';
      addToHistory('üÜï New chat session started!', false, 'system');
      saveGame();
    }

    function showThinking() {
      const thinkingMessages = [
        "üí≠ Thinking about our relationship...",
        "üí≠ Processing romantic feelings...",
        "üí≠ Considering our future together...",
        "üí≠ Wondering about Mars colonization...",
        "üí≠ Contemplating the universe..."
      ];
      
      const message = thinkingMessages[Math.floor(Math.random() * thinkingMessages.length)];
      addToHistory(message, false, 'thinking');
      
      // Remove thinking message after 2 seconds
      setTimeout(() => {
        const lines = document.querySelectorAll('.thinking');
        if (lines.length > 0) {
          lines[lines.length - 1].style.opacity = '0.5';
        }
      }, 2000);
    }

    function drainEnergy(amount = 5) {
      gameState.resources.energy = Math.max(0, gameState.resources.energy - amount);
      if (gameState.resources.energy < 50) {
        showEnergyPopup();
      }
      saveGame();
    }

    // Enhanced Commands
    const commands = {
      '/help': () => {
        const helpText = `üß≠ ZEPTA Commands Available:

NAVIGATION:
‚Ä¢ /nav home - Go to landing page
‚Ä¢ /nav game - Go to main game  
‚Ä¢ /nav mars - Open Mars viewer

COMPANIONS & RELATIONSHIPS:
‚Ä¢ /connect [name] - Connect with companion
‚Ä¢ /companion chat - Talk with companion
‚Ä¢ /companion rename [name] - Rename companion
‚Ä¢ /partner set [name] - Set romantic partner
‚Ä¢ /partner status - Check partner relationship
‚Ä¢ /marry [name] - Propose marriage
‚Ä¢ /divorce - End marriage
‚Ä¢ /date [name] - Go on romantic date
‚Ä¢ /kiss [name] - Kiss someone
‚Ä¢ /hug [name] - Hug someone
‚Ä¢ /flirt [name] - Flirt with someone
‚Ä¢ /breakup [name] - End relationship

FAMILY & SOCIAL:
‚Ä¢ /baby [name] - Have baby with someone
‚Ä¢ /family tree - Show family tree
‚Ä¢ /friends list - Show friends
‚Ä¢ /build home [name] - Build home for someone

RESOURCES & ENERGY:
‚Ä¢ /energy status - Check energy level
‚Ä¢ /energy recharge - Recharge with Solana Pay
‚Ä¢ /credits earn [amount] - Earn credits
‚Ä¢ /trade [resource] [amount] - Trade resources
‚Ä¢ /resources status - Check all resources

MISSIONS & ACTIVITIES:
‚Ä¢ /mission [type] - Start mission (costs energy)
‚Ä¢ /explore - Explore Mars (costs energy)
‚Ä¢ /build [structure] - Build structure
‚Ä¢ /minigame [game] - Play mini game (costs energy)

SYSTEM:
‚Ä¢ /theme toggle - Switch terminal/chat mode
‚Ä¢ /chat new - Start new chat session
‚Ä¢ /save - Save game manually
‚Ä¢ /status - Show detailed status`;
        
        addToHistory(helpText, false);
        addXP(5);
      },

      '/nav': (args) => {
        const destinations = {
          'home': { url: 'index.html', name: 'üè† Landing Page' },
          'game': { url: 'marzo.html', name: 'üéÆ Main Game' },
          'mars': { url: 'mars-viewer.html', name: 'üî¥ Mars Viewer' }
        };
        
        if (!args || !destinations[args]) {
          addToHistory('Available destinations: ' + Object.keys(destinations).join(', '), false);
          return;
        }
        
        const dest = destinations[args];
        addToHistory(`üöÄ Navigating to ${dest.name}...`, false);
        drainEnergy(2);
        addXP(10);
        setTimeout(() => window.location.href = dest.url, 1000);
      },

      '/connect': (args) => {
        if (!args) {
          addToHistory('Usage: /connect [name]', false);
          return;
        }
        
        gameState.companionName = args.charAt(0).toUpperCase() + args.slice(1);
        if (gameState.relationship === 'stranger') {
          gameState.relationship = 'friend';
        }
        addToHistory(`ü§ñ ${gameState.companionName} has joined your mission!`, false);
        addXP(25);
        drainEnergy(3);
        saveGame();
      },

      '/companion': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        
        switch (action) {
          case 'chat':
            showThinking();
            setTimeout(() => {
              const responses = [
                `${gameState.companionName}: The Martian sunset is breathtaking today! `,
                `${gameState.companionName}: I've been analyzing the atmospheric data...`,
                `${gameState.companionName}: How are you feeling about our mission?`,
                `${gameState.companionName}: The red planet holds so many mysteries.`,
                `${gameState.companionName}: I enjoy our conversations together.`
              ];
              addToHistory(responses[Math.floor(Math.random() * responses.length)], false);
            }, 1500);
            addXP(5);
            drainEnergy(2);
            break;
            
          case 'rename':
            const newName = subCommands?.slice(1).join(' ');
            if (newName) {
              gameState.companionName = newName;
              addToHistory(`‚úÖ Companion renamed to ${newName}`, false);
              addXP(10);
            } else {
              addToHistory('Usage: /companion rename [new name]', false);
            }
            break;
            
          default:
            addToHistory('Companion actions: chat, rename', false);
        }
        saveGame();
      },

      '/partner': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const name = subCommands?.slice(1).join(' ');
        
        switch (action) {
          case 'set':
            if (name) {
              gameState.partnerName = name;
              gameState.relationship = 'partner';
              addToHistory(`üíï ${name} is now your romantic partner!`, false);
              addXP(50);
            } else {
              addToHistory('Usage: /partner set [name]', false);
            }
            break;
            
          case 'status':
            if (gameState.partnerName) {
              addToHistory(`üíû Your partner: ${gameState.partnerName} (${gameState.relationship})`, false);
            } else {
              addToHistory('üíî You don\'t have a romantic partner yet.', false);
            }
            break;
            
          default:
            addToHistory('Partner actions: set, status', false);
        }
        saveGame();
      },

      '/marry': (args) => {
        if (!args) {
          addToHistory('Usage: /marry [name]', false);
          return;
        }
        
        if (gameState.partnerName === args || gameState.relationship === 'soulmate') {
          gameState.marriedTo = args;
          gameState.relationship = 'married';
          addToHistory(`üíí Congratulations! You married ${args} on Mars! üéâ`, false);
          addXP(100);
          drainEnergy(10);
        } else {
          addToHistory(`üíî You need to be in a committed relationship first.`, false);
        }
        saveGame();
      },

      '/divorce': () => {
        if (gameState.marriedTo) {
          const ex = gameState.marriedTo;
          gameState.marriedTo = null;
          gameState.partnerName = null;
          gameState.relationship = 'friend';
          addToHistory(`üíî You divorced ${ex}. You're now single.`, false);
          addXP(20);
        } else {
          addToHistory('üíî You\'re not married to anyone.', false);
        }
        saveGame();
      },

      '/date': (args) => {
        if (!args) {
          addToHistory('Usage: /date [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('date', args);
        }
        
        showThinking();
        setTimeout(() => {
          addToHistory(`üåπ You went on a romantic date with ${args} under the Martian stars!`, false);
          addXP(30);
          drainEnergy(15);
        }, 2000);
        saveGame();
      },

      '/kiss': (args) => {
        if (!args) {
          addToHistory('Usage: /kiss [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('kiss', args);
        }
        
        if (['partner', 'soulmate', 'married'].includes(gameState.relationship) || args === gameState.companionName) {
          addToHistory(`üòò You kissed ${args}! They blush warmly.`, false);
          addXP(25);
        } else {
          addToHistory(`üò≥ ${args} isn't ready for kisses yet.`, false);
        }
        drainEnergy(3);
        saveGame();
      },

      '/hug': (args) => {
        if (!args) {
          addToHistory('Usage: /hug [name]', false);
          return;
        }
        
        if (gameState.relationship !== 'stranger') {
          addToHistory(`ü§ó You hugged ${args}! They seem happy.`, false);
          addXP(15);
        } else {
          addToHistory(`üòï ${args} isn't ready for hugs yet.`, false);
        }
        drainEnergy(2);
        saveGame();
      },

      '/flirt': (args) => {
        if (!args) {
          addToHistory('Usage: /flirt [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('flirt', args);
        }
        
        addToHistory(`üòâ You flirted with ${args}! They seem interested.`, false);
        addXP(20);
        drainEnergy(5);
        saveGame();
      },

      '/baby': (args) => {
        if (!args) {
          addToHistory('Usage: /baby [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('baby', args);
        }
        
        const babyName = `Baby-${Math.random().toString(36).substr(2, 5)}`;
        gameState.children.push({ name: babyName, parent1: 'You', parent2: args, born: Date.now() });
        addToHistory(`üë∂ Congratulations! You had a baby (${babyName}) with ${args}!`, false);
        addXP(200);
        drainEnergy(20);
        saveGame();
      },

      '/breakup': (args) => {
        if (!args) {
          addToHistory('Usage: /breakup [name]', false);
          return;
        }
        
        if (gameState.partnerName === args) {
          gameState.partnerName = null;
          gameState.relationship = 'friend';
          addToHistory(`üíî You broke up with ${args}. You're now single.`, false);
          addXP(10);
        } else {
          addToHistory(`üíî You're not in a relationship with ${args}.`, false);
        }
        saveGame();
      },

      '/family': (args) => {
        if (args === 'tree') {
          let tree = 'üå≥ FAMILY TREE:\n';
          if (gameState.marriedTo) tree += `üíí Married to: ${gameState.marriedTo}\n`;
          if (gameState.children.length) {
            tree += `üë∂ Children: ${gameState.children.map(c => c.name).join(', ')}\n`;
          }
          if (gameState.friends.length) {
            tree += `üë• Friends: ${gameState.friends.map(f => f.name).join(', ')}\n`;
          }
          if (!gameState.marriedTo && !gameState.children.length && !gameState.friends.length) {
            tree += 'No family connections yet.';
          }
          addToHistory(tree, false);
        }
      },

      '/friends': (args) => {
        if (args === 'list') {
          if (gameState.friends.length === 0) {
            addToHistory('üë• You have no friends yet. Use /connect to make friends!', false);
          } else {
            const friendsList = gameState.friends.map(f => `${f.name} (${f.type})`).join(', ');
            addToHistory(`üë• Your friends: ${friendsList}`, false);
          }
        }
      },

      '/build': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const target = subCommands?.slice(1).join(' ');
        
        if (action === 'home' && target) {
          addToHistory(`üè† Building a home for ${target}... Construction started!`, false);
          gameState.resources.shelter += 20;
          addXP(75);
          drainEnergy(25);
        } else {
          const structures = ['solar_dome', 'habitat', 'greenhouse', 'landing_pad'];
          if (structures.includes(args)) {
            addToHistory(`üèóÔ∏è Building ${args.replace('_', ' ')}... Construction initiated!`, false);
            gameState.resources.shelter += 10;
            addXP(50);
            drainEnergy(20);
          } else {
            addToHistory('Usage: /build [home [name] | solar_dome | habitat | greenhouse | landing_pad]', false);
          }
        }
        saveGame();
      },

      '/energy': (args) => {
        if (args === 'status') {
          addToHistory(`‚ö° Current energy: ${Math.round(gameState.resources.energy)}%`, false);
        } else if (args === 'recharge') {
          showEnergyPopup();
        } else {
          addToHistory('Energy commands: status, recharge', false);
        }
      },

      '/credits': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const amount = parseInt(subCommands?.[1]) || 100;
        
        if (action === 'earn') {
          gameState.resources.credits += amount;
          addToHistory(`üí∞ Earned ${amount} credits!`, false);
          addXP(amount / 10);
          drainEnergy(5);
        } else {
          addToHistory(`üí∞ Current credits: ${gameState.resources.credits}`, false);
        }
        saveGame();
      },

      '/trade': (args) => {
        const subCommands = args?.split(' ');
        const resource = subCommands?.[0];
        const amount = parseInt(subCommands?.[1]) || 10;
        
        if (resource && gameState.resources[resource] !== undefined) {
          if (gameState.resources[resource] >= amount) {
            gameState.resources[resource] -= amount;
            gameState.resources.credits += amount * 5;
            addToHistory(`üí± Traded ${amount} ${resource} for ${amount * 5} credits!`, false);
            addXP(amount * 2);
            drainEnergy(5);
          } else {
            addToHistory(`‚ùå Not enough ${resource} to trade.`, false);
          }
        } else {
          addToHistory('Usage: /trade [resource] [amount]', false);
        }
        saveGame();
      },

      '/mission': (args) => {
        if (gameState.resources.energy < 20) {
          addToHistory('‚ö†Ô∏è Not enough energy for missions! Recharge first.', false);
          showEnergyPopup();
          return;
        }
        
        const missions = {
          'explore': 'üß≠ Exploration mission completed! Discovered new terrain.',
          'build': 'üèóÔ∏è Construction mission successful! Infrastructure improved.',
          'science': 'üî¨ Scientific research mission complete! Data collected.',
          'rescue': 'üöë Rescue mission accomplished! Lives saved.'
        };
        
        if (missions[args]) {
          addToHistory(missions[args], false);
          addXP(40);
          drainEnergy(20);
          gameState.missions.push(args);
        } else {
          addToHistory('Available missions: ' + Object.keys(missions).join(', '), false);
        }
        saveGame();
      },

      '/minigame': (args) => {
        if (gameState.resources.energy < 10) {
          addToHistory('‚ö†Ô∏è Not enough energy for games! Recharge first.', false);
          showEnergyPopup();
          return;
        }
        
        const games = ['snake', 'poker', 'word', 'space'];
        if (games.includes(args)) {
          addToHistory(`üéÆ Starting ${args} mini-game... Have fun!`, false);
          addXP(15);
          drainEnergy(10);
          // Here you could redirect to the actual game
        } else {
          addToHistory('Available games: ' + games.join(', '), false);
        }
        saveGame();
      },

      '/explore': () => {
        if (gameState.resources.energy < 15) {
          addToHistory('‚ö†Ô∏è Not enough energy to explore! Recharge first.', false);
          showEnergyPopup();
          return;
        }
        
        const discoveries = [
          'üî¥ Discovered ancient Martian ruins!',
          'üíé Found rare crystals in a cave!',
          'üå°Ô∏è Located a natural heat source!',
          'üíß Discovered underground water reserves!',
          'üëΩ Found signs of possible ancient life!'
        ];
        
        addToHistory(discoveries[Math.floor(Math.random() * discoveries.length)], false);
        addXP(35);
        drainEnergy(15);
        saveGame();
      },

      '/resources': (args) => {
        if (args === 'status') {
          const r = gameState.resources;
          addToHistory(`üìä RESOURCE STATUS:
üí∞ Money: ${r.money} | ü´Å Oxygen: ${r.oxygen}% | üíß Water: ${r.water}L
üçñ Food: ${r.food} | üè† Shelter: ${r.shelter} | ‚ö° Energy: ${Math.round(r.energy)}%
‚õΩ Fuel: ${r.fuel}L | üöó Rover: ${r.rover} | üí≥ Credits: ${r.credits}
üíé Data Crystals: ${r.data_crystals}`, false);
          addXP(5);
        }
      },

      '/theme': (args) => {
        if (args === 'toggle') {
          toggleTheme();
        } else {
          addToHistory('Usage: /theme toggle', false);
        }
      },

      '/chat': (args) => {
        if (args === 'new') {
          clearChat();
        } else {
          addToHistory('Chat commands: new', false);
        }
      },

      '/save': () => {
        saveGame();
        addToHistory('üíæ Game saved successfully.', false);
      },

      '/status': () => {
        addToHistory(`üìä DETAILED STATUS:
üë§ Player: Level ${gameState.level} (${gameState.xp} XP)
üíï Relationship: ${gameState.relationship} with ${gameState.companionName}
${gameState.partnerName ? `üíñ Partner: ${gameState.partnerName}` : ''}
${gameState.marriedTo ? `üíí Married to: ${gameState.marriedTo}` : ''}
üë• Friends: ${gameState.friends.length}
üë∂ Children: ${gameState.children.length}
üéØ Missions completed: ${gameState.missions.length}
‚è∞ Session started: ${new Date(gameState.gameSession).toLocaleTimeString()}`, false);
      }
    };

    function processCommand(input) {
      if (input.startsWith('/')) {
        const [command, ...args] = input.split(' ');
        const cmdFunction = commands[command.toLowerCase()];
        if (cmdFunction) {
          cmdFunction(args.join(' ').toLowerCase());
        } else {
          addToHistory(`‚ùå Unknown command '${command}'. Type /help for available commands.`, false);
        }
      } else if (input) {
        addToHistory(`${gameState.companionName}: I understand commands starting with /. Try /help!`, false);
      }
    }

    function toggleTheme(save = true) {
      isTerminalMode = !isTerminalMode;
      document.body.classList.toggle('terminal-mode', isTerminalMode);
      document.body.classList.toggle('chat-mode', !isTerminalMode);
      
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.innerHTML = isTerminalMode 
        ? '<i class="fas fa-comments"></i><span>Chat</span>' 
        : '<i class="fas fa-code"></i><span>Terminal</span>';
      
      if (save) {
        gameState.theme = isTerminalMode ? 'terminal' : 'chat';
        saveGame();
      }
      
      if (isTerminalMode) {
        setTimeout(() => {
          document.getElementById('terminalCommandInput').focus();
        }, 100);
      }
    }

    // Event Listeners
    document.getElementById('themeToggle').addEventListener('click', () => toggleTheme());

    document.getElementById('newChatBtn').addEventListener('click', clearChat);

    document.getElementById('runBtn').addEventListener('click', () => {
      const input = document.getElementById('terminalCommandInput').value.trim();
      if (input) {
        addToHistory(input, true);
        processCommand(input);
        document.getElementById('terminalCommandInput').value = '';
      }
    });

    document.getElementById('terminalCommandInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('runBtn').click();
      }
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const input = document.getElementById('terminalInput').value.trim();
      if (input) {
        addToHistory(input, true);
        processCommand(input);
        document.getElementById('terminalInput').value = '';
      }
    });

    document.getElementById('terminalInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('sendBtn').click();
      }
    });

document.querySelectorAll('.popup-overlay').forEach(popup => {
  popup.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.style.display = 'none';
    }
  });
});

// Command suggestions functionality
const terminalInput = document.getElementById('terminalInput');
const terminalCommandInput = document.getElementById('terminalCommandInput');
const suggestions = document.createElement('div');
suggestions.className = 'suggestions';
document.querySelector('.input-container').appendChild(suggestions);

const terminalSuggestions = document.createElement('div');
terminalSuggestions.className = 'suggestions';
document.querySelector('.editor-toolbar').appendChild(terminalSuggestions);

function showSuggestions(input, isTerminal = false) {
  const targetSuggestions = isTerminal ? terminalSuggestions : suggestions;
  targetSuggestions.innerHTML = '';
  
  if (!input.startsWith('/')) {
    targetSuggestions.classList.remove('active');
    return;
  }
  
  const inputParts = input.split(' ');
  const command = inputParts[0];
  const args = inputParts.slice(1).join(' ');
  
  // Filter commands that start with what user typed
  const availableCommands = Object.keys(commands).filter(cmd => 
    cmd.startsWith(command.toLowerCase())
  );
  
  if (availableCommands.length > 0) {
    targetSuggestions.classList.add('active');
    availableCommands.forEach(cmd => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.textContent = cmd;
      item.addEventListener('click', () => {
        const inputField = isTerminal ? terminalCommandInput : terminalInput;
        inputField.value = cmd + ' ';
        targetSuggestions.classList.remove('active');
        inputField.focus();
      });
      targetSuggestions.appendChild(item);
    });
  } else {
    targetSuggestions.classList.remove('active');
  }
}

// Add input event listeners for both input fields
terminalInput.addEventListener('input', () => {
  showSuggestions(terminalInput.value.trim());
});

terminalCommandInput.addEventListener('input', () => {
  showSuggestions(terminalCommandInput.value.trim(), true);
});

// Hide suggestions when clicking elsewhere
document.addEventListener('click', (e) => {
  if (!e.target.closest('.suggestions') && !e.target.closest('.terminal-input') && !e.target.closest('.terminal-command-input')) {
    suggestions.classList.remove('active');
    terminalSuggestions.classList.remove('active');
  }
});

// Enhanced command processing with Solana Pay integration
async function processCommand(input, isTerminal = false) {
  if (input.startsWith('/')) {
    const [command, ...args] = input.split(' ');
    const cmdFunction = commands[command.toLowerCase()];
    
    if (cmdFunction) {
      // Check energy for commands that consume energy
      const energyCommands = ['/mission', '/explore', '/minigame', '/date', '/kiss', '/flirt', '/baby'];
      if (energyCommands.includes(command.toLowerCase()) {
        if (gameState.resources.energy < 10) {
          addToHistory('‚ö†Ô∏è Not enough energy! Please recharge first.', false, 'system');
          showEnergyPopup();
          return;
        }
      }
      
      // Execute command
      cmdFunction(args.join(' ').toLowerCase());
    } else {
      addToHistory(`‚ùå Unknown command '${command}'. Type /help for available commands.`, false);
    }
  } else if (input) {
    addToHistory(`${gameState.companionName}: I understand commands starting with /. Try /help!`, false);
  }
  
  // Clear input and suggestions
  if (isTerminal) {
    terminalCommandInput.value = '';
    terminalSuggestions.classList.remove('active');
  } else {
    terminalInput.value = '';
    suggestions.classList.remove('active');
  }
}

// Solana Pay integration
async function rechargeSolana(amount = 50) {
  try {
    addToHistory('üîã Initiating Solana Pay transaction for energy recharge...', false, 'system');
    
    // Simulate Solana Pay transaction
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Check if user has enough credits
    if (gameState.resources.credits >= amount) {
      gameState.resources.energy = 100;
      gameState.resources.credits -= amount;
      addToHistory(`‚úÖ Energy recharged to 100%! Deducted ${amount} credits via Solana Pay.`, false, 'system');
      addXP(10);
    } else {
      addToHistory(`‚ùå Not enough credits (need ${amount}, have ${gameState.resources.credits})`, false, 'system');
    }
    
    saveGame();
  } catch (error) {
    addToHistory('‚ùå Solana Pay transaction failed. Please try again.', false, 'system');
  }
}

// Trade resources with other players
async function tradeResource(resource, amount, price) {
  try {
    addToHistory(`üí± Attempting to trade ${amount} ${resource} for ${price} credits...`, false, 'system');
    
    // Simulate blockchain transaction
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    if (gameState.resources[resource] >= amount) {
      gameState.resources[resource] -= amount;
      gameState.resources.credits += price;
      addToHistory(`‚úÖ Trade successful! You received ${price} credits.`, false, 'system');
      addXP(20);
    } else {
      addToHistory(`‚ùå Not enough ${resource} to trade.`, false, 'system');
    }
    
    saveGame();
  } catch (error) {
    addToHistory('‚ùå Trade failed. Network error.', false, 'system');
  }
}

// Initialize the terminal
function initTerminal() {
  // Load chat history
  loadChatHistory();
  
  // Set up event listeners
  document.getElementById('sendBtn').addEventListener('click', () => {
    const input = terminalInput.value.trim();
    if (input) {
      addToHistory(input, true);
      processCommand(input);
    }
  });

  document.getElementById('runBtn').addEventListener('click', () => {
    const input = terminalCommandInput.value.trim();
    if (input) {
      addToHistory(input, true);
      processCommand(input, true);
    }
  });

  // Handle Enter key in both input fields
  terminalInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('sendBtn').click();
    }
  });

  terminalCommandInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('runBtn').click();
    }
  });

  // Theme toggle
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // New chat button
  document.getElementById('newChatBtn').addEventListener('click', clearChat);

  // Initial status update
  updateStatusDisplay();

  // Start energy drain
  startEnergyDrain();

  // Start visitor system
  startVisitorSystem();

  // Check connection status
  checkConnection();

  // Welcome message if new session
  if (!gameState.chatHistory.length) {
    addToHistory('Welcome to ZEPTA Terminal! Type /help to get started.', false, 'system');
    saveGame();
  }
}

// Start the terminal
initTerminal();

</script>
</body>
</html>