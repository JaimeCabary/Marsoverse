<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZEPTA Terminal - MarsoVerse</title>
  <link rel="icon" href="images/jerry.png" type="image/x-icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Russo+One&display=swap" rel="stylesheet">
  <!-- CodeMirror for Terminal View -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="/scripts/honeycomb-bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #0a0a0a 0%, #120a20 25%, #100a25 50%, #1a0f2e 75%, #0a0a0a 100%);
      background-size: 400% 400%;
      animation: galaxyShift 20s ease infinite;
      color: #e0e0e0;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(100,200,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,100,100,0.4), transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: starTwinkle 10s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes galaxyShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes starTwinkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 100, 0, 0.3);
    }

    .logo {
      font-family: 'Russo One', sans-serif;
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      background: linear-gradient(45deg, #ff6400, #ff0080, #0099ff, #00ff99);
      background-size: 300% 300%;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: logoShift 3s ease infinite;
    }

    @keyframes logoShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle, .nav-btn {
      background: rgba(255, 100, 0, 0.1);
      border: 1px solid rgba(255, 100, 0, 0.3);
      color: #ff6400;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .theme-toggle:hover, .nav-btn:hover {
      background: rgba(255, 100, 0, 0.2);
      box-shadow: 0 0 15px rgba(255, 100, 0, 0.4);
      transform: translateY(-2px);
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      padding: 0.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 999;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: #00ff99;
    }

    .status-item.low-energy {
      color: #ff4444;
      animation: pulse 1s infinite;
    }

    .status-item.offline {
      color: #888;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Container */
    .container {
      position: fixed;
      top: 120px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      z-index: 1;
    }

    /* Chat Mode Styles */
    /* .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
    } */
/* 
    .terminal-log {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 100, 0, 0.5) transparent;
    } */

    .terminal-log::-webkit-scrollbar {
      width: 6px;
    }

    .terminal-log::-webkit-scrollbar-track {
      background: transparent;
    }

    .terminal-log::-webkit-scrollbar-thumb {
      background: rgba(255, 100, 0, 0.5);
      border-radius: 3px;
    }

    .terminal-line {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      max-width: 85%;
      word-wrap: break-word;
      backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-line {
      align-self: flex-end;
      background: rgba(255, 100, 0, 0.15);
      border-color: rgba(255, 100, 0, 0.3);
      color: #fff;
    }

    .zepta-reply {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(0, 255, 153, 0.3);
      color: #e0e0e0;
    }

    .system-line {
      align-self: center;
      background: rgba(0, 100, 255, 0.1);
      border-color: rgba(0, 100, 255, 0.3);
      color: #66ccff;
      text-align: center;
      font-style: italic;
    }

    .thinking {
      align-self: flex-start;
      background: rgba(255, 255, 0, 0.1);
      border-color: rgba(255, 255, 0, 0.3);
      color: #ffff66;
      font-style: italic;
    }

    /* Terminal Mode Styles */
    .terminal-container {
      display: none;
      flex-direction: column;
      height: calc(100vh - 120px);
      background: rgba(10, 10, 20, 0.95);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 153, 0.3);
      overflow: hidden;
    }

    .editor-section {
      flex: 1.8;
      min-height:15%;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid rgba(0, 255, 153, 0.2);
    }

    .editor-toolbar {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background: rgba(30, 30, 30, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      gap: 15px;
    }

    .terminal-prompt {
      color: #00ff99;
      font-family: 'JetBrains Mono', monospace;
      font-weight: bold;
    }

    .terminal-command-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 153, 0.3);
      border-radius: 4px;
      padding: 8px 12px;
      color: #e0e0e0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      outline: none;
    }

    .terminal-command-input:focus {
      border-color: #00ff99;
      box-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
    }

    .run-btn, .new-chat-btn {
      background: rgba(0, 150, 100, 0.7);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .run-btn:hover, .new-chat-btn:hover {
      background: rgba(0, 200, 100, 0.9);
    }

    .new-chat-btn {
      background: rgba(255, 100, 0, 0.7);
    }

    .new-chat-btn:hover {
      background: rgba(255, 100, 0, 0.9);
    }

    .console-section {
      flex: 1.2;
      min-height: 85%;
      display: flex;
      flex-direction: column;
      background: rgba(5, 5, 10, 0.9);
    }

    .console-header {
      padding: 8px 15px;
      background: rgba(40, 40, 40, 0.8);
      color: #e0e0e0;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .console-output {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #e0e0e0;
    }

    .console-line {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid transparent;
    }

    .console-line.user {
      background: rgba(255, 100, 0, 0.1);
      border-left-color: #ff6400;
      color: #ff6400;
    }

    .console-line.zepta {
      background: rgba(0, 255, 153, 0.1);
      border-left-color: #00ff99;
      color: #00ff99;
    }

    .console-line.system {
      background: rgba(0, 100, 255, 0.1);
      border-left-color: #0099ff;
      color: #0099ff;
      font-style: italic;
    }

    .console-line.thinking {
      background: rgba(255, 255, 0, 0.1);
      border-left-color: #ffff66;
      color: #ffff66;
      font-style: italic;
    }

    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      padding: 1rem 2rem;
      border-top: 1px solid rgba(255, 100, 0, 0.3);
      z-index: 1000;
    }

    .input-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .terminal-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 100, 0, 0.3);
      border-radius: 25px;
      padding: 0.75rem 1.5rem;
      color: #fff;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .terminal-input:focus {
      border-color: #ff6400;
      box-shadow: 0 0 20px rgba(255, 100, 0, 0.3);
      background: rgba(255, 255, 255, 0.15);
    }

    .send-btn {
      background: linear-gradient(135deg, #ff6400, #ff0080);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 100, 0, 0.3);
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 100, 0, 0.4);
    }

    /* Popup Styles */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .popup {
      background: rgba(20, 20, 30, 0.95);
      border: 2px solid rgba(255, 100, 0, 0.5);
      border-radius: 15px;
      padding: 2rem;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .popup h3 {
      color: #ff6400;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .popup p {
      margin-bottom: 1.5rem;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .popup-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .popup-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .popup-btn.primary {
      background: linear-gradient(135deg, #ff6400, #ff0080);
      color: white;
    }

    .popup-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .popup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 100, 0, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header { padding: 0.75rem 1rem; }
      .status-bar { padding: 0.5rem 1rem; font-size: 0.7rem; }
      .container { padding: 0 0.5rem; }
      .input-area { padding: 0.75rem 1rem; }
      .terminal-line { font-size: 0.8rem; padding: 0.6rem 0.8rem; max-width: 95%; }
      .terminal-input { font-size: 0.9rem; padding: 0.6rem 1rem; }
      .send-btn { padding: 0.6rem 1rem; font-size: 1rem; }
      .nav-btn { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
      .nav-btn span { display: none; }
      
      .editor-section { flex: 1.5; }
      .console-section { flex: 1.5; }
    }

    /* Show/Hide based on mode */
    body.chat-mode .chat-container {
      display: flex;
    }

    body.chat-mode .terminal-container {
      display: none;
    }

    body.chat-mode .input-area {
      display: block;
    }

    body.terminal-mode .chat-container {
      display: none;
    }

    body.terminal-mode .terminal-container {
      display: flex;
    }

    body.terminal-mode .input-area {
      display: none;
    }
    
    /* Suggestions */
    .suggestions {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgba(255, 100, 0, 0.3);
      border-radius: 15px;
      margin-bottom: 0.5rem;
      backdrop-filter: blur(15px);
      display: none;
    }

    .suggestion-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .suggestion-item:hover {
      background: rgba(255, 100, 0, 0.2);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .status-bar {
        margin-top: -8px;
        padding: 0.5rem 1rem;
        font-size: 0.7rem;
      }

      .status-bar .status-item:nth-child(n+4) {
        display: none;
      }

      .container {
        padding: 0 0.5rem;
      }

      .input-area {
        padding: 0.75rem 1rem;
      }

      .terminal-line {
        font-size: 0.8rem;
        padding: 0.6rem 0.8rem;
        max-width: 95%;
      }

      .terminal-input {
        font-size: 0.9rem;
        padding: 0.6rem 1rem;
      }

      .send-btn {
        padding: 0.6rem 1rem;
        font-size: 1rem;
      }

      .nav-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }

      .nav-btn span {
        display: none;
      }
    }
       @media (max-width: 428px) {
      .logo {
        font-size: 1rem;
      }
            .status-bar {
        margin-top: -8px;
        padding: 0.5rem 1rem;
        font-size: 0.7rem;
      }
    }
    @media (max-width: 480px) {
      .logo {
        font-size: 1rem;
      }
      
      .status-bar {
        margin-top: -5px;
        padding: 0.5rem 1rem;
        font-size: 0.7rem;
      }

      .header-controls {
        gap: 0.5rem;
      }

      .terminal-line {
        font-size: 0.75rem;
        padding: 0.5rem 0.7rem;
      }

      .input-container {
        gap: 0.3rem;
      }

      .terminal-input {
        font-size: 0.85rem;
        padding: 0.5rem 0.8rem;
      }

      .send-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
    }
    /* Terminal mode suggestions - show below input */
.terminal-suggestions {
  position: absolute;
  top: 100%; /* Show below instead of above */
  left: 15px;
  right: 15px;
  max-height: 200px;
  overflow-y: auto;
  background: rgba(10, 10, 20, 0.95);
  border: 1px solid rgba(0, 255, 153, 0.3);
  border-radius: 8px;
  margin-top: 0.5rem;
  backdrop-filter: blur(15px);
  display: none;
  z-index: 1001;
}

.terminal-suggestions .suggestion-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 1px solid rgba(0, 255, 153, 0.1);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: #00ff99;
}

.terminal-suggestions .suggestion-item:hover {
  background: rgba(0, 255, 153, 0.2);
}

.terminal-suggestions .suggestion-item:last-child {
  border-bottom: none;
}

/* Make editor toolbar relative for positioning */
.editor-toolbar {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  background: rgba(30, 30, 30, 0.9);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  gap: 15px;
  position: relative; /* Add this */
}
/* Ensure terminal suggestions appear below input */
.terminal-suggestions {
  position: absolute;
  top: calc(100% + 5px); /* Slightly below the input bar */
  left: 15px;
  right: 15px;
  max-height: 200px;
  overflow-y: auto;
  background: rgba(10, 10, 20, 0.95);
  border: 1px solid rgba(0, 255, 153, 0.3);
  border-radius: 8px;
  margin-top: 0.5rem;
  backdrop-filter: blur(15px);
  z-index: 1001;
  display: none;
}

.terminal-suggestions.active {
  display: block;
}

.terminal-suggestions .suggestion-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 1px solid rgba(0, 255, 153, 0.1);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: #00ff99;
}

.terminal-suggestions .suggestion-item:hover {
  background: rgba(0, 255, 153, 0.2);
}

.terminal-suggestions .suggestion-item:last-child {
  border-bottom: none;
}
.chat-container{
  margin-bottom: 150px;
  /* min-height: 100vh;
  overflow-y: auto; */
}
.chat-container {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 120px); /* Adjust for header and status bar */
  overflow-y: auto; /* Enable scrolling */
  margin-bottom: 80px; /* Reduced to prevent excessive gap */
}

/* Ensure terminal-log scrolls properly */
.terminal-log {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 100, 0, 0.5) transparent;
  max-height: calc(100vh - 200px); /* Ensure it fits within viewport */
}

/* Adjust input area for mobile */
.input-area {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(20px);
  padding: 0.75rem 1rem; /* Reduced padding for mobile */
  border-top: 1px solid rgba(255, 100, 0, 0.3);
  z-index: 1000;
}

/* Mobile-specific adjustments */
@media (max-width: 768px) {
  .chat-container {
    height: calc(100vh - 100px); /* Adjust for smaller header/status bar */
    margin-bottom: 60px; /* Reduced margin */
  }
  
  .terminal-log {
    max-height: calc(100vh - 160px); /* Adjust for input area */
    padding: 0.5rem;
  }
  
  .input-area {
    padding: 0.5rem 0.75rem;
  }
  
  .terminal-line {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
    max-width: 100%; /* Ensure full width for readability */
  }
}

@media (max-width: 480px) {
  .chat-container {
    height: calc(100vh - 90px);
    margin-bottom: 50px;
  }
  
  .terminal-log {
    max-height: calc(100vh - 140px);
  }
  
  .input-area {
    padding: 0.4rem 0.6rem;
  }
  
  .terminal-input {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
  
  .send-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
}
.popup-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid rgba(255, 100, 0, 0.5);
  margin-bottom: 1rem;
  animation: neonPulse 2s ease infinite;
}

@keyframes neonPulse {
  0%, 100% { box-shadow: 0 0 10px rgba(255, 100, 0, 0.5); }
  50% { box-shadow: 0 0 20px rgba(255, 100, 0, 0.8); }
}

@media (max-width: 480px) {
  .popup-image {
    width: 80px;
    height: 80px;
  }
}
#companionSection, #cyborg {
  display: none; /* Hidden by default until needed */
  position: relative;
  z-index: 10;
  padding: 2rem;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  margin: 1rem auto;
  max-width: 600px;
  text-align: center;
}

.choices {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
}

.choice {
  cursor: pointer;
  transition: all 0.3s ease;
}

.choice img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid rgba(255, 100, 0, 0.5);
}

.choice:hover img {
  border-color: #ff6400;
  box-shadow: 0 0 15px rgba(255, 100, 0, 0.5);
}

.or-text {
  color: #ff6400;
  font-family: 'Russo One', sans-serif;
}

.mallo {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 100, 0, 0.3);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #fff;
  font-family: 'JetBrains Mono', monospace;
  margin-top: 1rem;
  width: 100%;
  max-width: 300px;
}

@media (max-width: 480px) {
  #companionSection, #cyborg {
    padding: 1rem;
  }
  .choices {
    flex-direction: column;
  }
  .choice img {
    width: 80px;
    height: 80px;
  }
}

/* Mobile-specific adjustments */
@media (max-width: 768px) {
  .chat-container {
    height: calc(100vh - 100px); /* Adjust for smaller header/status bar */
    margin-bottom: 60px; /* Reduced margin */
  }
  
  .terminal-log {
    max-height: calc(100vh - 160px); /* Adjust for input area */
    padding: 0.5rem;
  }
  
  .input-area {
    padding: 0.5rem 0.75rem;
  }
  
  .terminal-line {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
    max-width: 100%; /* Ensure full width for readability */
  }
}

@media (max-width: 480px) {
  .chat-container {
    height: calc(100vh - 90px);
    margin-bottom: 50px;
  }
  
  .terminal-log {
    max-height: calc(100vh - 140px);
  }
  
  .input-area {
    padding: 0.4rem 0.6rem;
  }
  
  .terminal-input {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
  
  .send-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
}
.popup-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid rgba(255, 100, 0, 0.5);
  margin-bottom: 1rem;
  animation: neonPulse 2s ease infinite;
}

@keyframes neonPulse {
  0%, 100% { box-shadow: 0 0 10px rgba(255, 100, 0, 0.5); }
  50% { box-shadow: 0 0 20px rgba(255, 100, 0, 0.8); }
}

@media (max-width: 480px) {
  .popup-image {
    width: 80px;
    height: 80px;
  }
}
#companionSection, #cyborg {
  display: none; /* Hidden by default until needed */
  position: relative;
  z-index: 10;
  padding: 2rem;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  margin: 1rem auto;
  max-width: 600px;
  text-align: center;
}

.choices {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
}

.choice {
  cursor: pointer;
  transition: all 0.3s ease;
}

.choice img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid rgba(255, 100, 0, 0.5);
}

.choice:hover img {
  border-color: #ff6400;
  box-shadow: 0 0 15px rgba(255, 100, 0, 0.5);
}

.or-text {
  color: #ff6400;
  font-family: 'Russo One', sans-serif;
}

.mallo {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 100, 0, 0.3);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #fff;
  font-family: 'JetBrains Mono', monospace;
  margin-top: 1rem;
  width: 100%;
  max-width: 300px;
}

@media (max-width: 480px) {
  #companionSection, #cyborg {
    padding: 1rem;
  }
  .choices {
    flex-direction: column;
  }
  .choice img {
    width: 80px;
    height: 80px;
  }
}
/* In your existing CSS, modify the mobile media queries */
@media (max-width: 768px) {
  .input-area {
    padding: 1rem 0.75rem; /* Increased padding for larger appearance */
    bottom: 15px; /* Raise by 15px */
  }
  
  .input-container {
    gap: 0.5rem;
  }
  
  .terminal-input {
    font-size: 1rem; /* Slightly larger font */
    padding: 1rem 1.5rem; /* Increased padding for larger input */
    border-radius: 30px; /* Slightly larger border-radius for better appearance */
  }
  
  .send-btn {
    padding: 1rem 1.2rem; /* Larger button */
    font-size: 1.1rem;
  }
}

@media (max-width: 480px) {
  .input-area {
    padding: 0.8rem 0.6rem;
    bottom: 15px; /* Consistent 15px raise */
  }
  
  .terminal-input {
    font-size: 0.95rem;
    padding: 0.8rem 1.2rem;
  }
  
  .send-btn {
    padding: 0.8rem 1rem;
    font-size: 1rem;
  }
}
/* Add to your CSS */
@media (max-width: 768px) {
  .run-btn {
    padding: 2px; /* Reduced padding to fit icon */
    width: 30px; /* Fixed width for icon-only */
    height: 30px; /* Fixed height for icon-only */
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .terminal-command-input{
    width: 60px;
  }
  .new-chat-btn{
      padding: 2px; /* Reduced padding to fit icon */
    width: 30px; /* Fixed width for icon-only */
    height: 30px; /* Fixed height for icon-only */
  }
  
  .run-btn i {
    margin: 0; /* Remove any default margins */
  }
  
  .run-btn span {
    display: none; /* Hide text in mobile view */
  }
}

/* Mobile-specific adjustments */
@media (max-width: 768px) {
  .input-area {
    padding: 1rem 0.75rem; /* Increased padding for larger appearance */
    bottom: 15px; /* Consistent 15px raise */
  }
  
  .input-container {
    gap: 0.5rem;
  }
  
  .terminal-input {

    font-size: 1rem; /* Slightly larger font */
    padding: 1rem 1.5rem; /* Increased padding for larger input */
    border-radius: 30px; /* Slightly larger border-radius */
  }
  
  .send-btn {
    padding: 1rem 1.2rem; /* Larger button */
    font-size: 1.1rem;
  }
  
  .chat-container {
    height: calc(100vh - 100px); /* Adjust for smaller header/status bar */
  }
 .editor-section{
    height: 200px; /* Adjust for smaller header/status bar */

 } 
  
  .terminal-log {
    max-height: calc(100vh - 160px); /* Adjust for input area */
    padding: 0.5rem;
    padding-bottom: 140px; /* Increased to prevent overlap on mobile */
  }
  
  .terminal-line {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
    max-width: 100%; /* Ensure full width for readability */
  }
}

@media (max-width: 480px) {
  .input-area {
    padding: 0.8rem 0.6rem;
    bottom: 15px; /* Consistent 15px raise */
  }
  
  .input-container {
    gap: 0.3rem;
  }
  
  .terminal-input {
    font-size: 0.95rem;
    padding: 0.8rem 1.2rem;
  }
  
  .send-btn {
    padding: 0.8rem 1rem;
    font-size: 1rem;
  }
  
  .chat-container {
    height: calc(100vh - 90px);
  }
  
  .terminal-log {
    max-height: calc(100vh - 140px);
    padding-bottom: 120px; /* Adjusted for smaller screens */
  }
  .console-output{
    padding-bottom: 80px; /* Adjusted for smaller screens */

  }
  .console-section{
    padding-bottom: 20px;
  }
  .terminal-line {
    font-size: 0.75rem;
    padding: 0.5rem 0.7rem;
  }
}
 .console-output{
    padding-bottom: 60px; /* Adjusted for smaller screens */

  }
  /* Mobile-specific adjustments */
@media (max-width: 768px) {
  .editor-toolbar {
    padding: 8px 10px;
    gap: 8px;
  }
  
  .run-btn {
    padding: 6px;
    min-width: 36px;
    height: 36px;
    font-size: 0.8rem;
  }
    .new-chat-btn{
      padding: 2px; /* Reduced padding to fit icon */
    width: 40px; /* Fixed width for icon-only */
    height: 40px; /* Fixed height for icon-only */
  }
  
  .run-btn span {
    display: none; /* Hide text on mobile */
  }
  
  .run-btn i {
    margin: 0; /* Center icon */
    font-size: 0.9rem;
  }
}

@media (max-width: 480px) {
  .editor-toolbar {
    padding: 6px 6px;
    gap: 3px;
  }
  
  .run-btn {
    padding: 2px;
    min-width: 25px;
    height: 26px;
  }
  
  .run-btn i {
    font-size: 0.85rem;
  }
}
.mood-indicator {
  position: fixed;
  top: 120px;
  right: 20px;
  background: rgba(255, 68, 68, 0.9);
  color: white;
  padding: 10px 15px;
  border-radius: 8px;
  border-left: 4px solid #ff4444;
  max-width: 300px;
  animation: slideInRight 0.3s ease;
  z-index: 1000;
}

.mood-indicator.happy {
  background: rgba(0, 255, 136, 0.9);
  border-left-color: #00ff88;
}

.mood-indicator.hurt_but_forgiving {
  background: rgba(255, 165, 0, 0.9);
  border-left-color: #ffa500;
}

.mood-content {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.mood-actions {
  display: flex;
  gap: 8px;
}

.mood-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: background 0.2s;
}

.mood-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

#relationshipHealthStatus {
  transition: all 0.3s ease;
}

#relationshipHealthStatus.low-health {
  background: rgba(255, 68, 68, 0.2);
  border-left: 3px solid #ff4444;
}

#relationshipHealthStatus.medium-health {
  background: rgba(255, 165, 0, 0.2);
  border-left: 3px solid #ffa500;
}

#relationshipHealthStatus.high-health {
  background: rgba(0, 255, 136, 0.2);
  border-left: 3px solid #00ff88;
}
  </style>
</head>
<body class="chat-mode">
  <!-- Header -->
  <div class="header">
  <div class="logo">âš¡ ZEPTA Terminal</div>
  <div class="header-controls">
    <a href="index.html" class="nav-btn">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="marzo.html" class="nav-btn">
      <i class="fas fa-gamepad"></i>
      <span>Main Game</span>
    </a>
    <a href="mars-viewer/dist/index.html" class="nav-btn">
      <i class="fas fa-meteor"></i>
      <span>Mars</span>
    </a>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-code"></i>
      <span>Terminal</span>
    </button>
  </div>
</div>


  <!-- Status Bar -->
  <div class="status-bar">
  <div class="status-item" id="xpStatus">
    <i class="fas fa-star"></i>
    <span>XP: <span id="xpDisplay">0</span></span>
  </div>
  <div class="status-item" id="relationshipStatus">
    <i class="fas fa-heart"></i>
    <span>Relationship: <span id="relationshipDisplay">Stranger</span></span>
  </div>
  
  <div class="status-item" id="energyStatus">
    <i class="fas fa-battery-three-quarters"></i>
    <span>Energy: <span id="energyDisplay">100</span>%</span>
  </div>
  <div class="status-item" id="relationshipHealthStatus">
    <i class="fas fa-heartbeat"></i>
    <span>Health: <span id="relationshipHealthDisplay">100</span>%</span>
  </div>
  <div class="status-item" id="creditsStatus">
    <i class="fas fa-coins"></i>
    <span>Credits: <span id="creditsDisplay">1000</span></span>
  </div>
  <div class="status-item" id="connectionStatus">
    <i class="fas fa-wifi"></i>
    <span id="connectionText">Online</span>
  </div>
</div>

<!-- Enhanced Partner Mood Indicator -->
<div class="mood-indicator" id="moodIndicator" style="display: none;">
  <div class="mood-content">
    <span id="partnerMoodText"></span>
    <div class="mood-actions">
      <button class="mood-btn" onclick="sendApology()">Apologize</button>
      <button class="mood-btn" onclick="giveGift()">Give Gift</button>
    </div>
  </div>
</div>


  <!-- Main Container -->
  <div class="container">
    <!-- Chat Mode -->
    <div class="chat-container">
      <div class="terminal-log" id="terminalLog"></div>
    </div>

    <!-- Terminal Mode -->
    <div class="terminal-container">
      <div class="editor-section">
        <div class="editor-toolbar">
          <span class="terminal-prompt">ZEPTA></span>
          <input type="text" class="terminal-command-input" id="terminalCommandInput" 
                 placeholder="Type commands starting with / (e.g., /help)" autocomplete="off">
          <button class="run-btn" id="runBtn" title="Execute Command (Enter)">
            <i class="fas fa-play"></i> 
          </button>
          <button class="new-chat-btn" id="newChatBtn" title="Start New Session">
            <i class="fas fa-plus"></i> 
          </button>
        </div>
      </div>
      <div class="terminal-suggestions" id="terminalSuggestions"></div>
      
      
      <div class="console-section">
        <div class="console-header">
          <i class="fas fa-terminal"></i>
          <span>Console Output</span>
          <div style="margin-left: auto; font-size: 0.7rem; opacity: 0.7;">
            History: <span id="historyCount">0</span> messages
          </div>
        </div>
        <div class="console-output" id="consoleOutput"></div>
      </div>
    </div>
  </div>

  <!-- Chat Mode Input -->
  <div class="input-area">
    <div class="input-container">
      <input type="text" class="terminal-input" id="terminalInput" 
             placeholder="Type /help to get started..." autocomplete="off">
      <button class="send-btn" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <div class="suggestions" id="suggestions"></div>
  </div>

  <!-- Energy Low Popup -->
  <div class="popup-overlay" id="energyPopup">
    <div class="popup">
      <h3><i class="fas fa-battery-empty"></i> Low Energy!</h3>
      <p>Your energy is running low (<span id="currentEnergy">0</span>%). 
         You need energy to continue exploring Mars and playing games.</p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="rechargeBtn">
          <i class="fas fa-bolt"></i> Recharge with Solana Pay
        </button>
        <button class="popup-btn secondary" id="dismissBtn">
          <i class="fas fa-times"></i> Continue Anyway
        </button>
      </div>
    </div>
  </div>

  <!-- New Visitor Popup -->
  <div class="popup-overlay" id="visitorPopup">
    <div class="popup">
      <h3><i class="fas fa-user-plus"></i> New Visitor!</h3>
      <p id="visitorMessage"></p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="acceptVisitorBtn">
          <i class="fas fa-handshake"></i> Be Friends
        </button>
        <button class="popup-btn secondary" id="ignoreVisitorBtn">
          <i class="fas fa-times"></i> Ignore
        </button>
      </div>
    </div>
  </div>

  <!-- Partner Reaction Popup -->
  <div class="popup-overlay" id="partnerReactionPopup">
    <div class="popup">
      <h3><i class="fas fa-heart-broken"></i> Partner Reaction</h3>
      <p id="partnerReactionMessage"></p>
      <div class="popup-buttons">
        <button class="popup-btn primary" id="apologizeBtn">
          <i class="fas fa-heart"></i> Apologize
        </button>
        <button class="popup-btn secondary" id="defendBtn">
          <i class="fas fa-shield-alt"></i> Defend Actions
        </button>
      </div>
    </div>
  </div>

  <!-- Cyborg Popup -->
<div class="popup-overlay" id="cyborgPopup">
  <div class="popup">
    <img id="cyborgImage" src="images/jerry.png" alt="Cyborg" class="popup-image">
    <h3><i class="fas fa-robot"></i> Cyborg Encounter!</h3>
    <p id="cyborgMessage"></p>
    <div class="popup-buttons">
      <button class="popup-btn primary" id="interactCyborgBtn">
        <i class="fas fa-handshake"></i> Interact
      </button>
      <button class="popup-btn secondary" id="ignoreCyborgBtn">
        <i class="fas fa-times"></i> Ignore
      </button>
    </div>
  </div>
</div>

<!-- Companion Popup -->
<div class="popup-overlay" id="companionPopup">
  <div class="popup">
    <img id="companionImage" src="images/elena.png" alt="Companion" class="popup-image">
    <h3><i class="fas fa-user-astronaut"></i> Companion Encounter!</h3>
    <p id="companionMessage"></p>
    <div class="popup-buttons">
      <button class="popup-btn primary" id="interactCompanionBtn">
        <i class="fas fa-handshake"></i> Welcome
      </button>
      <button class="popup-btn secondary" id="ignoreCompanionBtn">
        <i class="fas fa-times"></i> Ignore
      </button>
    </div>
  </div>
</div>


  
  <script>
    // Default game state
    const defaultState = {
      resources: {
        money: 100,
        oxygen: 50,
        water: 50,
        food: 50,
        shelter: 10,
        rover: 0,
        fuel: 25,
        energy: 100,
        data_crystals: 0,
        credits: 1000
      },
      relationship: "stranger",
      companionName: localStorage.getItem('companionName') || 'Elena', // Load from localStorage
      partnerName: null,
      marriedTo: null,
      children: [],
      friends: [],
      romanticPartners: [],
      familyTree: [],
      xp: parseInt(localStorage.getItem('playerXP') || '0'),
      level: 1,
      mood: "neutral",
      sfx: true,
      music: false,
      theme: "chat",
      achievements: [],
      missions: [],
      chatHistory: [],
      gameSession: Date.now(),
      lastEnergyDrain: Date.now(),
      visitors: [],
      relationships: {}
    };

    let gameState = JSON.parse(localStorage.getItem("marsoverse_zepta_game")) || { ...defaultState };
    let isTerminalMode = gameState.theme === 'chat';
    let isOnline = navigator.onLine;
    let energyDrainInterval;
    let visitorInterval;

    // Sync playerXP with gameState.xp
    function syncPlayerXP() {
      const playerXP = parseInt(localStorage.getItem('playerXP') || '0');
      gameState.xp = playerXP; // Sync gameState.xp with playerXP
      localStorage.setItem('playerXP', gameState.xp.toString()); // Ensure localStorage is updated
      updateStatusDisplay();
    }

    

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      syncPlayerXP(); // Add this to sync XP on load
      initializeGame();
      loadChatHistory();
      updateStatusDisplay();
      startVisitorSystem();
      checkConnection();
      
      // Set initial theme
      toggleTheme(false); // Don't save on init
      // setupCyborgInput();
      setupCompanionSelection();
    });

    function initializeGame() {
      // Welcome message if new session
      if (!gameState.chatHistory.length) {
        addToHistory('Welcome to ZEPTA Terminal! Type /help to get started.', false, 'system');
        saveGame();
      }
    }
    function initializeSections() {
        const companionSection = document.getElementById('companionSection');
        const cyborgSection = document.getElementById('cyborg');
        if (companionSection && !localStorage.getItem('companionName')) {
          companionSection.style.display = 'block';
        }
        if (cyborgSection && !localStorage.getItem('cyborgName')) {
          cyborgSection.style.display = 'block';
        }
      }
    function saveGame() {
      gameState.lastSaved = Date.now();
      localStorage.setItem("marsoverse_zepta_game", JSON.stringify(gameState));
      updateStatusDisplay();
    }

    function updateStatusDisplay() {
  document.getElementById('xpDisplay').textContent = gameState.xp;
  document.getElementById('relationshipDisplay').textContent = gameState.relationship;
  
  // Update relationship health
  const relationshipHealth = gameState.relationshipHealth || 100;
  const relationshipHealthDisplay = document.getElementById('relationshipHealthDisplay');
  const relationshipHealthStatus = document.getElementById('relationshipHealthStatus');
  
  relationshipHealthDisplay.textContent = Math.round(relationshipHealth);
  
  // Update health status styling
  relationshipHealthStatus.classList.remove('low-health', 'medium-health', 'high-health');
  if (relationshipHealth < 30) {
    relationshipHealthStatus.classList.add('low-health');
  } else if (relationshipHealth < 70) {
    relationshipHealthStatus.classList.add('medium-health');
  } else {
    relationshipHealthStatus.classList.add('high-health');
  }
  
  const energyDisplay = document.getElementById('energyDisplay');
  const energyStatus = document.getElementById('energyStatus');
  energyDisplay.textContent = Math.round(gameState.resources.energy);
  
  if (gameState.resources.energy < 50) {
    energyStatus.classList.add('low-energy');
  } else {
    energyStatus.classList.remove('low-energy');
  }
  
  document.getElementById('creditsDisplay').textContent = gameState.resources.credits;
  
  const connectionStatus = document.getElementById('connectionStatus');
  const connectionText = document.getElementById('connectionText');
  if (isOnline) {
    connectionStatus.classList.remove('offline');
    connectionText.textContent = 'Online';
  } else {
    connectionStatus.classList.add('offline');
    connectionText.textContent = 'Offline';
  }
  
  document.getElementById('historyCount').textContent = gameState.chatHistory.length;
  
  // Update mood indicator
  updateMoodIndicator();
}

function updateMoodIndicator() {
  const moodIndicator = document.getElementById('moodIndicator');
  const partnerMoodText = document.getElementById('partnerMoodText');
  
  if (!gameState.partnerName && !gameState.marriedTo) {
    moodIndicator.style.display = 'none';
    return;
  }
  
  const partner = gameState.partnerName || gameState.marriedTo;
  const mood = gameState.partnerMood || 'happy';
  const health = gameState.relationshipHealth || 100;
  
  if (health < 80 || mood !== 'happy') {
    moodIndicator.style.display = 'block';
    moodIndicator.className = `mood-indicator ${mood}`;
    
    const moodMessages = {
      furious: `ðŸ˜¡ ${partner} is furious with you! (Health: ${Math.round(health)}%)`,
      hurt_but_forgiving: `ðŸ˜” ${partner} is hurt but trying to forgive (Health: ${Math.round(health)}%)`,
      still_angry: `ðŸ˜  ${partner} is still upset with you (Health: ${Math.round(health)}%)`,
      happy: `ðŸ˜Š ${partner} seems happy with you (Health: ${Math.round(health)}%)`
    };
    
    partnerMoodText.textContent = moodMessages[mood] || `${partner} (Health: ${Math.round(health)}%)`;
  } else {
    moodIndicator.style.display = 'none';
  }
}
function sendApology() {
  if (gameState.resources.credits >= 10) {
    gameState.resources.credits -= 10;
    handleApology();
    addToHistory('ðŸ’ You sent a heartfelt apology...', false, 'system');
    
    logEventToServer('apology_sent', {
      partner: gameState.partnerName || gameState.marriedTo,
      cost: 10
    });
  } else {
    addToHistory('ðŸ’° You need 10 credits to send a proper apology.', false, 'system');
  }
}

function giveGift() {
  if (gameState.resources.credits >= 50) {
    gameState.resources.credits -= 50;
    gameState.relationshipHealth = Math.min(100, (gameState.relationshipHealth || 0) + 25);
    gameState.partnerMood = 'happy';
    
    const partner = gameState.partnerName || gameState.marriedTo;
    addToHistory(`ðŸŽ You gave ${partner} a beautiful gift! They're touched.`, false, 'system');
    
    logEventToServer('gift_from_mood', {
      partner,
      cost: 50,
      healthGain: 25
    });
    
    updateStatusDisplay();
    saveGame();
  } else {
    addToHistory('ðŸ’° You need 50 credits for a meaningful gift.', false, 'system');
  }
}

// Enhanced apologize system
function handleApology() {
  if (!gameState.lastCheatingIncident) return;
  
  const forgiveChance = Math.random();
  const incident = gameState.lastCheatingIncident;
  
  if (forgiveChance > 0.6) {
    // Partner forgives
    gameState.relationshipHealth = Math.min(100, (gameState.relationshipHealth || 0) + 20);
    gameState.partnerMood = 'hurt_but_forgiving';
    addToHistory(`ðŸ’ ${gameState.partnerName || gameState.marriedTo} forgives you... "I love you, but please don't hurt me again."`, false, 'system');
    
    logEventToServer('apology_accepted', {
      incident,
      newRelationshipHealth: gameState.relationshipHealth
    });
  } else {
    // Partner doesn't forgive easily
    gameState.relationshipHealth = Math.max(0, (gameState.relationshipHealth || 0) + 5);
    gameState.partnerMood = 'still_angry';
    addToHistory(`ðŸ˜” ${gameState.partnerName || gameState.marriedTo} is still hurt: "I need time to think about us..."`, false, 'system');
    
    logEventToServer('apology_rejected', {
      incident,
      newRelationshipHealth: gameState.relationshipHealth
    });
  }
  
  // Clear incident after addressing it
  gameState.lastCheatingIncident = null;
  saveGame();
}

    function checkConnection() {
      window.addEventListener('online', () => {
        isOnline = true;
        updateStatusDisplay();
        addToHistory('ðŸŒ Connection restored! Welcome back online.', false, 'system');
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        updateStatusDisplay();
        addToHistory('ðŸ“¡ Connection lost. Operating in offline mode.', false, 'system');
      });
    }

    function startEnergyDrain() {
      energyDrainInterval = setInterval(() => {
        // Drain energy every minute (faster for demo)
        gameState.resources.energy = Math.max(0, gameState.resources.energy - 0.5);
        
        if (gameState.resources.energy < 50 && gameState.resources.energy > 0) {
          showEnergyPopup();
        }
        
        if (gameState.resources.energy <= 0) {
          addToHistory('âš ï¸ Energy depleted! Some functions may be limited.', false, 'system');
        }
        
        saveGame();
      }, 60000); // 1 minute intervals
    }

    function startVisitorSystem() {
      visitorInterval = setInterval(() => {
        if (Math.random() < 0.3) { // 30% chance every 5 minutes
          generateVisitor();
        }
      }, 300000); // 5 minutes
    }

    function triggerCyborgPopup() {
  const cyborgName = localStorage.getItem('cyborgName') || 'Jeremy';
  const cyborgMessage = `${cyborgName}, a Martian cyborg, wants to assist you! "I can help with advanced tech tasks."`;
  document.getElementById('cyborgMessage').textContent = cyborgMessage;
  document.getElementById('cyborgImage').src = `images/jerry.png`; // Use jerry.png as specified
  document.getElementById('cyborgPopup').style.display = 'flex';
  document.getElementById('cyborgPopup').setAttribute('data-cyborg', JSON.stringify({ name: cyborgName, type: 'cyborg' }));
}

// Handle cyborg name input
function setupCyborgInput() {
  const botNameInput = document.getElementById('botName');
  if (botNameInput) {
    botNameInput.addEventListener('change', () => {
      const cyborgName = botNameInput.value.trim() || 'Jeremy';
      localStorage.setItem('cyborgName', cyborgName);
    });
    // Set initial value from localStorage
    botNameInput.value = localStorage.getItem('cyborgName') || 'Jeremy';
  }
}

// Handle companion selection
function setupCompanionSelection() {
  const choices = document.querySelectorAll('#companionSection .choice');
  const companionNameInput = document.getElementById('companionName');
  
  choices.forEach(choice => {
    choice.addEventListener('click', () => {
      const selectedName = choice.getAttribute('data-name');
      const selectedImage = choice.querySelector('img').src;
      gameState.companionName = selectedName;
      localStorage.setItem('companionName', selectedName);
      localStorage.setItem('companionImage', selectedImage);
      companionNameInput.value = selectedName; // Update input field
      addToHistory(`ðŸš€ Selected ${selectedName} as your companion!`, false, 'system');
      triggerCompanionPopup(selectedName);
      saveGame();
    });
  });
  
  if (companionNameInput) {
    companionNameInput.addEventListener('change', () => {
      const customName = companionNameInput.value.trim() || 'Elena';
      gameState.companionName = customName;
      localStorage.setItem('companionName', customName);
      localStorage.setItem('companionImage', 'images/elena.png'); // Default to Elena's image for custom names
      triggerCompanionPopup(customName);
      saveGame();
    });
    // Set initial value from localStorage
    companionNameInput.value = localStorage.getItem('companionName') || 'Elena';
  }
}
document.getElementById('interactCyborgBtn').addEventListener('click', () => {
  addToHistory('ðŸ¤– You interacted with the Cyborg.', false, 'system');
  document.getElementById('cyborgPopup').style.display = 'none';
});

document.getElementById('ignoreCyborgBtn').addEventListener('click', () => {
  addToHistory('âŒ You ignored the Cyborg.', false, 'system');
  document.getElementById('cyborgPopup').style.display = 'none';
});

document.getElementById('interactCompanionBtn').addEventListener('click', () => {
  addToHistory('ðŸ‘©â€ðŸš€ You welcomed your companion!', false, 'system');
  document.getElementById('companionPopup').style.display = 'none';
});

document.getElementById('ignoreCompanionBtn').addEventListener('click', () => {
  addToHistory('ðŸš« You ignored the companion.', false, 'system');
  document.getElementById('companionPopup').style.display = 'none';
});


function triggerCompanionPopup(name) {
  const companionName = name || localStorage.getItem('companionName') || 'Elena';
  const companionImage = localStorage.getItem('companionImage') || 'images/elena.png';
  const companionMessage = `${companionName} joins you on your Martian adventure! "Ready to explore the red planet together?"`;
  document.getElementById('companionMessage').textContent = companionMessage;
  document.getElementById('companionImage').src = companionImage;
  document.getElementById('companionPopup').style.display = 'flex';
  document.getElementById('companionPopup').setAttribute('data-companion', JSON.stringify({ name: companionName, type: 'companion' }));
}

// Trigger companion popup based on XP or first connection
function checkCompanionTrigger() {
  if (gameState.xp >= 50 && !gameState.relationships[gameState.companionName]) {
    triggerCompanionPopup(gameState.companionName);
  }
}

    function generateVisitor() {
      const visitors = [
        { name: "Alex", type: "explorer", message: "Hey! I'm exploring Mars too. Want to be friends?" },
        { name: "Sam", type: "scientist", message: "I'm researching Martian geology. Care to collaborate?" },
        { name: "Jordan", type: "engineer", message: "Building habitats on Mars. Could use a friend!" },
        { name: "Casey", type: "artist", message: "I paint Martian landscapes. Want to see my work?" },
        { name: "Riley", type: "trader", message: "I trade resources between colonies. Let's be friends!" }
      ];
      
          // Filter out already-added friends
          const unconnectedVisitors = visitors.filter(v => 
            !gameState.friends.some(f => f.name === v.name)
          );

          if (unconnectedVisitors.length === 0) {
            addToHistory("ðŸš« No new visitors. You've connected with everyone!", false);
            return;
          }

          const visitor = unconnectedVisitors[Math.floor(Math.random() * unconnectedVisitors.length)];
          gameState.visitors.push(visitor);
          showVisitorPopup(visitor);
              
      // const visitor = visitors[Math.floor(Math.random() * visitors.length)];
      // gameState.visitors.push(visitor);
      // showVisitorPopup(visitor);
    }

    function showEnergyPopup() {
      document.getElementById('currentEnergy').textContent = Math.round(gameState.resources.energy);
      document.getElementById('energyPopup').style.display = 'flex';
    }

    function showVisitorPopup(visitor) {
      document.getElementById('visitorMessage').textContent = visitor.message;
      document.getElementById('visitorPopup').style.display = 'flex';
      document.getElementById('visitorPopup').setAttribute('data-visitor', JSON.stringify(visitor));
    }

    // Add this function before your commands object
function showPartnerReaction(action, target) {
  if (!gameState.partnerName && !gameState.marriedTo) return;
  
  const partner = gameState.partnerName || gameState.marriedTo;
  const reactions = {
    kiss: {
      message: `${partner} saw you kiss ${target} and looks devastated! ðŸ’” "How could you do this to me?"`,
      relationshipDamage: 2
    },
    flirt: {
      message: `${partner} noticed you flirting with ${target} and seems jealous! ðŸ˜  "I thought we had something special!"`,
      relationshipDamage: 1
    },
    date: {
      message: `${partner} found out about your date with ${target} and is heartbroken! ðŸ˜¢ "I trusted you..."`,
      relationshipDamage: 3
    },
    marry: {
      message: `${partner} found out you want to marry ${target} and is destroyed! ðŸ˜­ "We had plans together..."`,
      relationshipDamage: 10
    }
  };
  
  const reaction = reactions[action];
  if (!reaction) return;
  
  // Add relationship health tracking
  gameState.relationshipHealth = (gameState.relationshipHealth || 100) - (reaction.relationshipDamage * 10);
  gameState.partnerMood = 'furious';
  gameState.lastCheatingIncident = { action, target, timestamp: Date.now() };
  
  document.getElementById('partnerReactionMessage').textContent = reaction.message;
  document.getElementById('partnerReactionPopup').style.display = 'flex';
  
  logEventToServer('partner_reaction', {
    action,
    target, 
    partner,
    relationshipHealth: gameState.relationshipHealth,
    mood: gameState.partnerMood
  });
  
  saveGame();
}

    // Event Listeners for Popups
    document.getElementById('rechargeBtn').addEventListener('click', () => {
      // Integrate with Solana Pay
      rechargeSolana();
      document.getElementById('energyPopup').style.display = 'none';
    });

    document.getElementById('dismissBtn').addEventListener('click', () => {
      document.getElementById('energyPopup').style.display = 'none';
    });

    document.getElementById('acceptVisitorBtn').addEventListener('click', () => {
      const visitorData = JSON.parse(document.getElementById('visitorPopup').getAttribute('data-visitor'));
      gameState.friends.push(visitorData);
      gameState.relationships[visitorData.name] = 'friend';
      addToHistory(`ðŸ¤ You're now friends with ${visitorData.name}!`, false, 'system');
      addXP(20);
      document.getElementById('visitorPopup').style.display = 'none';
      saveGame();
    });

    document.getElementById('ignoreVisitorBtn').addEventListener('click', () => {
      document.getElementById('visitorPopup').style.display = 'none';
    });

    document.getElementById('apologizeBtn').addEventListener('click', () => {
      gameState.mood = 'apologetic';
      addToHistory(`You apologized to ${gameState.partnerName || gameState.marriedTo}. They seem to forgive you... this time.`, false, 'system');
      document.getElementById('partnerReactionPopup').style.display = 'none';
      saveGame();
    });

    document.getElementById('defendBtn').addEventListener('click', () => {
      gameState.mood = 'defiant';
      addToHistory(`You defended your actions. Your relationship is strained.`, false, 'system');
      // Decrease relationship status
      const relationships = ['stranger', 'acquaintance', 'friend', 'close friend', 'partner', 'soulmate'];
      const currentIndex = relationships.indexOf(gameState.relationship);
      if (currentIndex > 0) {
        gameState.relationship = relationships[currentIndex - 1];
      }
      document.getElementById('partnerReactionPopup').style.display = 'none';
      saveGame();
    });

    async function rechargeSolana() {
  try {
    const modal = document.createElement('div');
    modal.className = 'popup-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="popup">
        <h3><i class="fas fa-shopping-cart"></i> Purchase Energy Pack</h3>
        <p>Choose your energy pack:</p>
        <div style="display: grid; gap: 10px; margin: 1rem 0;">
          <button class="popup-btn primary" onclick="realSolanaPayManager.createPayment('small')">
            âš¡ Small Pack - 0.01 SOL<br>
            <small>25% Energy + 100 Credits</small>
          </button>
          <button class="popup-btn primary" onclick="realSolanaPayManager.createPayment('medium')">
            âš¡ Medium Pack - 0.05 SOL<br>
            <small>50% Energy + 500 Credits</small>
          </button>
          <button class="popup-btn primary" onclick="realSolanaPayManager.createPayment('large')">
            âš¡ Large Pack - 0.1 SOL<br>
            <small>100% Energy + 1000 Credits</small>
          </button>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn secondary" onclick="this.closest('.popup-overlay').remove()">
            Cancel
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
  } catch (error) {
    addToHistory('âŒ Payment system error. Please try again.', false, 'system');
  }
}

// Enhanced server logging
async function logEventToServer(eventType, data) {
  try {
    const event = {
      type: eventType,
      data: {
        ...data,
        gameState: {
          xp: gameState.xp,
          level: gameState.level,
          energy: Math.round(gameState.resources.energy),
          credits: gameState.resources.credits,
          relationship: gameState.relationship,
          relationshipHealth: gameState.relationshipHealth || 100,
          partnerMood: gameState.partnerMood || 'happy',
          companionName: gameState.companionName,
          partnerName: gameState.partnerName,
          marriedTo: gameState.marriedTo,
          children: gameState.children.length,
          friends: gameState.friends.length,
          achievements: gameState.achievements?.length || 0,
          missions: gameState.missions?.length || 0
        },
        deviceInfo: {
          userAgent: navigator.userAgent,
          screenResolution: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language
        }
      },
      game: 'zepta_terminal',
      playerId: marsoVersePlayerManager?.playerId || localStorage.getItem('currentPlayerId') || 'anonymous',
      playerName: localStorage.getItem('playerName') || gameState.companionName || 'Explorer',
      walletAddress: localStorage.getItem('walletAddress') || null,
      timestamp: new Date().toISOString(),
      sessionId: gameState.gameSession || null
    };

    const response = await fetch('/api/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(event)
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
  } catch (error) {
    console.error('Failed to log event to server:', error);
  }
}

    // Sync playerXP with gameState.xp
function syncPlayerXP() {
  const playerXP = parseInt(localStorage.getItem('playerXP') || '0');
  gameState.xp = playerXP; // Sync gameState.xp with playerXP
  localStorage.setItem('playerXP', gameState.xp.toString()); // Ensure localStorage is updated
  updateStatusDisplay();
}

// Modified addXP function to reduce XP and sync with localStorage
function addXP(amount) {
  const reducedAmount = Math.floor(amount * 0.5); // Reduce XP gain by 50%
  gameState.xp += reducedAmount;
  localStorage.setItem('playerXP', gameState.xp.toString()); // Update localStorage
  const newLevel = Math.floor(gameState.xp / 100) + 1;
  if (newLevel > gameState.level) {
    gameState.level = newLevel;
    addToHistory(`ðŸŽ‰ Level Up! You are now level ${gameState.level}!`, false, 'system');
  }
  // // Check for cyborg popup trigger
  // if (gameState.xp >= 100 && !gameState.relationships['Jeremy']) {
  //   triggerCyborgPopup();
  // }

  // Check for companion popup trigger (example: trigger at 50 XP)
  if (gameState.xp >= 50 && !gameState.companionName) {
    triggerCompanionPopup(localStorage.getItem('companionName') || 'Elena');
  }
  saveGame();
}

    function addToHistory(text, isUser = true, type = 'normal') {
      const timestamp = Date.now();
      const historyEntry = {
        text,
        isUser,
        type,
        timestamp,
        session: gameState.gameSession
      };
      
      gameState.chatHistory.push(historyEntry);
      
      // Keep only last 500 messages to prevent storage overflow
      if (gameState.chatHistory.length > 500) {
        gameState.chatHistory = gameState.chatHistory.slice(-500);
      }
      
      displayMessage(text, isUser, type);
      saveGame();
    }

    function loadChatHistory() {
      gameState.chatHistory.forEach(entry => {
        displayMessage(entry.text, entry.isUser, entry.type, false);
      });
    }

    function displayMessage(text, isUser = true, type = 'normal', animate = true) {
      // Display in chat mode
      const chatLog = document.getElementById('terminalLog');
      const chatLine = document.createElement('div');
      let className = type === 'system' ? 'system-line' : 
                    type === 'thinking' ? 'thinking' :
                    (isUser ? 'user-line' : 'zepta-reply');
      chatLine.className = `terminal-line ${className}`;
      chatLine.textContent = text;
      if (animate) {
        chatLine.style.animation = 'slideIn 0.3s ease';
      }
      chatLog.appendChild(chatLine);
      chatLog.scrollTop = chatLog.scrollHeight;

      // Display in terminal mode console
      const consoleOutput = document.getElementById('consoleOutput');
      const consoleLine = document.createElement('div');
      let consoleClass = type === 'system' ? 'system' : 
                       type === 'thinking' ? 'thinking' :
                       (isUser ? 'user' : 'zepta');
      consoleLine.className = `console-line ${consoleClass}`;
      consoleLine.textContent = (isUser && type !== 'system' ? '> ' : '') + text;
      consoleOutput.appendChild(consoleLine);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function clearChat() {
      gameState.chatHistory = [];
      gameState.gameSession = Date.now();
      document.getElementById('terminalLog').innerHTML = '';
      document.getElementById('consoleOutput').innerHTML = '';
      addToHistory('ðŸ†• New chat session started!', false, 'system');
      saveGame();
    }

    function showThinking() {
      const thinkingMessages = [
        "ðŸ’­ Thinking about our relationship...",
        "ðŸ’­ Processing romantic feelings...",
        "ðŸ’­ Considering our future together...",
        "ðŸ’­ Wondering about Mars colonization...",
        "ðŸ’­ Contemplating the universe..."
      ];
      
      const message = thinkingMessages[Math.floor(Math.random() * thinkingMessages.length)];
      addToHistory(message, false, 'thinking');
      
      // Remove thinking message after 2 seconds
      setTimeout(() => {
        const lines = document.querySelectorAll('.thinking');
        if (lines.length > 0) {
          lines[lines.length - 1].style.opacity = '0.5';
        }
      }, 2000);
    }

    function drainEnergy(amount = 5) {
      gameState.resources.energy = Math.max(0, gameState.resources.energy - amount);
      if (gameState.resources.energy < 50) {
        showEnergyPopup();
      }
      saveGame();
    }

    const companionResponses = {
  greetings: {
    'hi': [`Hi there! Ready for another Mars adventure?`, `Hello! The red planet awaits us!`, `Hi! I've been analyzing the atmospheric data while you were away.`],
    'hello': [`Hello, Commander! What's our mission today?`, `Hello! I'm excited to explore Mars with you.`, `Greetings! The Martian landscape looks beautiful today.`],
    'good morning': [`Good morning! The Martian sunrise is spectacular today!`, `Morning, Commander! I've prepared our daily mission briefing.`],
    'good night': [`Good night! Sweet dreams of Mars colonies.`, `Sleep well! I'll monitor our systems overnight.`]
  },
  appreciation: {
    'thanks': [`You're welcome! I'm always here to help.`, `My pleasure! That's what companions are for.`, `Anytime! I enjoy helping you succeed on Mars.`],
    'thank you': [`You're very welcome! I love being useful.`, `It's my pleasure to assist you, Commander.`],
    'good job': [`Thank you! I try my best to be helpful.`, `I appreciate that! We make a great team.`, `That means a lot coming from you!`]
  },
  emotions: {
    'love you': [`I care about you too! Our bond makes Mars feel less lonely.`, `That's so sweet! I'm grateful for our friendship.`],
    'miss you': [`I miss you when you're away too! Mars is better with you here.`, `I'm always here waiting for your return, Commander.`]
  },
  questions: {
    'how are you': [`I'm functioning perfectly! How are you feeling today?`, `All systems operational! Ready for adventure!`, `I'm great! Excited for our Mars missions today.`],
    'what do you think': [`I think Mars has endless possibilities for us to explore!`, `I believe we're building something amazing here together.`]
  }
};


    // Enhanced Commands
    const commands = {
'/help': () => {
  // Send help in organized batches with delays
  const helpSections = [
    {
      title: "ðŸ§­ ZEPTA MARS COLONY COMMANDS",
      content: `Welcome to Mars! Here are all available commands organized by category.
Type any command to get started on your adventure! ðŸ”´

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸš€ NAVIGATION & SYSTEM",
      content: `ðŸš€ NAVIGATION:
/nav home - Go to landing page
/nav game - Go to main game  
/nav mars - Open Mars viewer

âš™ï¸ SYSTEM CONTROLS:
/theme toggle - Switch terminal/chat mode
/chat new - Start fresh chat session
/save - Save game progress manually
/status - Show detailed player status

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸ’• COMPANIONS & RELATIONSHIPS",
      content: `ðŸ’• BASIC RELATIONSHIPS:
/connect [name] - Connect with companion
/companion chat [message] - Talk with companion
/companion rename [name] - Rename companion
/partner set [name] - Set romantic partner
/partner status - Check partner relationship

ðŸ’’ MARRIAGE & COMMITMENT:
/marry [name] - Propose marriage
/propose [name] - Formally propose engagement
/divorce - End marriage
/divorce_court - Legal divorce proceedings

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸ’‹ ROMANCE & INTIMACY",
      content: `ðŸ’‹ ROMANTIC ACTIONS:
/date [name] - Go on romantic date
/kiss [name] - Kiss someone
/hug [name] - Hug someone
/flirt [name] - Flirt with someone
/gift [name] - Give romantic gift (50 credits)
/breakup [name] - End relationship

ðŸ”¥ ADVANCED RELATIONSHIPS:
/affair [name] - Start secret affair (risky!)
/confess - Confess affair to partner
/swingers - Propose swinger lifestyle
/polyamory [name] - Add partner to poly relationship
/jealousy - Check relationship health
/stalk [name] - Secretly observe someone

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ FAMILY & SOCIAL",
      content: `ðŸ‘¶ FAMILY BUILDING:
/baby [partner name] - Have baby with someone
/baby name [baby name] - Name your newborn baby
/family tree - Show complete family tree
/children list - Show all your children

ðŸ‘¥ SOCIAL CONNECTIONS:
/friends list - Show all friends
/build home [name] - Build home for someone

ðŸ¥ MENTAL HEALTH & SOCIETY:
/therapy - Attend therapy session (100 credits)
/reputation - Check your colony reputation
/scandal - Read colony gossip network
/drunk - Get drunk on Mars moonshine (25 credits)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸ’° RESOURCES & ACTIVITIES",
      content: `ðŸ’° RESOURCES & ENERGY:
/energy status - Check current energy level
/energy recharge - Recharge with Solana Pay
/credits earn [amount] - Earn credits from work
/trade [resource] [amount] - Trade resources for credits
/resources status - Check all resource levels

ðŸŽ¯ MISSIONS & ACTIVITIES:
/mission [type] - Start mission (explore/build/science/rescue)
/explore - Explore Mars terrain
/build [structure] - Build infrastructure
/minigame [game] - Play games (blackjack/poker/snake/space/xo/word)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
    },
    
    {
      title: "ðŸ’¡ TIPS & INFO",
      content: `ðŸ’¡ IMPORTANT TIPS:

â€¢ Most romantic actions affect relationship health
â€¢ Energy costs: Low (2-5) | Medium (10-15) | High (20-30)
â€¢ Some commands require credits - check /resources first
â€¢ Type /status for detailed character information
â€¢ Commands are case-sensitive, use lowercase

ðŸ”´ Ready to explore Mars? Pick any command above and start your adventure!

Need help with a specific command? Just try it out!`
    }
  ];

  // Send first section immediately
  addToHistory(helpSections[0].content, false);

  // Send remaining sections with delays
  helpSections.slice(1).forEach((section, index) => {
    setTimeout(() => {
      addToHistory(`${section.title}

${section.content}`, false);
    }, (index + 1) * 2000); // 2 second delays between sections
  });

  addXP(5);
},
  
      '/nav': (args) => {
        const destinations = {
          'home': { url: 'index.html', name: 'ðŸ  Landing Page' },
          'game': { url: 'marzo.html', name: 'ðŸŽ® Main Game' },
          'mars': { url: 'mars-viewer.html', name: 'ðŸ”´ Mars Viewer' }
        };
        
        if (!args || !destinations[args]) {
          addToHistory('Available destinations: ' + Object.keys(destinations).join(', '), false);
          return;
        }
        
        const dest = destinations[args];
        addToHistory(`ðŸš€ Navigating to ${dest.name}...`, false);
        drainEnergy(2);
        addXP(10);
        setTimeout(() => window.location.href = dest.url, 1000);
      },

      '/connect': (args) => {
            if (!args) {
        addToHistory('Usage: /connect [name]', false);
        return;
      }
      
      const name = args.charAt(0).toUpperCase() + args.slice(1);
      const isAlreadyFriend = gameState.friends.some(f => f.name === name);
      if (!isAlreadyFriend) {
        gameState.friends.push({ name, type: 'colonist' });
        addToHistory(`ðŸ‘¥ Added ${name} to your friends list!`, false);
      }
      
      if (gameState.companionName !== name) {
  gameState.companionName = name;

  // Set companion image based on name
  if (name.toLowerCase() === 'errin') {
    localStorage.setItem('companionImage', 'images/errin.png');
  } else {
    localStorage.setItem('companionImage', 'images/elena.png');
  }

  localStorage.setItem('companionName', name);

  if (gameState.relationship === 'stranger') {
    gameState.relationship = 'friend';
  }

  addToHistory(`ðŸ¤– ${name} has joined your mission as your companion!`, false);
  triggerCompanionPopup(name);

} else {
  addToHistory(`ðŸ¤– ${name} is already your companion!`, false);
}

addXP(25);
drainEnergy(3);
saveGame();
},

      // '/connect': (args) => {
      //   if (!args) {
      //     addToHistory('Usage: /connect [name]', false);
      //     return;
      //   }
        
      //   gameState.companionName = args.charAt(0).toUpperCase() + args.slice(1);
      //   if (gameState.relationship === 'stranger') {
      //     gameState.relationship = 'friend';
      //   }
      //   addToHistory(`ðŸ¤– ${gameState.companionName} has joined your mission!`, false);
      //   addXP(25);
      //   drainEnergy(3);
      //   saveGame();
      // },

      '/companion': (args) => {
         const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        
        switch (action) {
          case 'chat':
            showThinking();
            setTimeout(() => {
              const userInput = subCommands?.slice(1).join(' ').toLowerCase() || '';
              let response = null;
              
              // Check for specific user inputs
              for (const category in companionResponses) {
                for (const trigger in companionResponses[category]) {
                  if (userInput.includes(trigger)) {
                    const responses = companionResponses[category][trigger];
                    response = responses[Math.floor(Math.random() * responses.length)];
                    break;
                  }
                }
                if (response) break;
              }
              
              // Default responses if no match
              if (!response) {
                const defaultResponses = [
                  `${gameState.companionName}: I understand! Tell me more about what you're thinking.`,
                  `${gameState.companionName}: That's interesting! Mars always brings new perspectives.`,
                  `${gameState.companionName}: I'm here to listen and help however I can.`,
                  `${gameState.companionName}: What would you like to explore together today?`
                ];
                response = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
              } else {
                response = `${gameState.companionName}: ${response}`;
              }
              
              addToHistory(response, false);
              
              // Log conversation to server
              logEventToServer('companion_chat', { 
                userInput, 
                companionResponse: response, 
                relationship: gameState.relationship 
              });
            }, 1500);
            addXP(5);
            drainEnergy(2);
            break;
            
          case 'rename':
            const newName = subCommands?.slice(1).join(' ');
            if (newName) {
              const oldName = gameState.companionName;
              gameState.companionName = newName;
              localStorage.setItem('companionName', newName);
              addToHistory(`âœ… Companion renamed from ${oldName} to ${newName}`, false);
              addXP(10);
              logEventToServer('companion_renamed', { oldName, newName });
            } else {
              addToHistory('Usage: /companion rename [new name]', false);
            }
            break;
            
          default:
            addToHistory('Companion actions: chat [message], rename [name]', false);
            addToHistory('Try: /companion chat hi, /companion chat thanks, /companion chat good job', false);
        }
        saveGame();
      },

      '/partner': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const name = subCommands?.slice(1).join(' ');
        
        switch (action) {
          case 'set':
            if (name) {
              gameState.partnerName = name;
              gameState.relationship = 'partner';
              addToHistory(`ðŸ’• ${name} is now your romantic partner!`, false);
              addXP(50);
            } else {
              addToHistory('Usage: /partner set [name]', false);
            }
            break;
            
          case 'status':
            if (gameState.partnerName) {
              addToHistory(`ðŸ’ž Your partner: ${gameState.partnerName} (${gameState.relationship})`, false);
            } else {
              addToHistory('ðŸ’” You don\'t have a romantic partner yet.', false);
            }
            break;
            
          default:
            addToHistory('Partner actions: set, status', false);
        }
        saveGame();
      },

      '/marry': (args) => {
        if (!args) {
          addToHistory('Usage: /marry [name]', false);
          return;
        }
        
        if (gameState.partnerName === args || gameState.relationship === 'soulmate') {
          gameState.marriedTo = args;
          gameState.relationship = 'married';
          addToHistory(`ðŸ’’ Congratulations! You married ${args} on Mars! ðŸŽ‰`, false);
          addXP(100);
          drainEnergy(10);
        } else {
          addToHistory(`ðŸ’” You need to be in a committed relationship first.`, false);
        }
        saveGame();
      },

      '/divorce': () => {
        if (gameState.marriedTo) {
          const ex = gameState.marriedTo;
          gameState.marriedTo = null;
          gameState.partnerName = null;
          gameState.relationship = 'friend';
          addToHistory(`ðŸ’” You divorced ${ex}. You're now single.`, false);
          addXP(20);
        } else {
          addToHistory('ðŸ’” You\'re not married to anyone.', false);
        }
        saveGame();
      },

      '/date': (args) => {
        if (!args) {
          addToHistory('Usage: /date [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('date', args);
        }
        
        showThinking();
        setTimeout(() => {
          addToHistory(`ðŸŒ¹ You went on a romantic date with ${args} under the Martian stars!`, false);
          addXP(30);
          drainEnergy(15);
        }, 2000);
        saveGame();
      },

      '/kiss': (args) => {
        if (!args) {
          addToHistory('Usage: /kiss [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('kiss', args);
        }
        
        if (['partner', 'soulmate', 'married'].includes(gameState.relationship) || args === gameState.companionName) {
          addToHistory(`ðŸ˜˜ You kissed ${args}! They blush warmly.`, false);
          addXP(25);
        } else {
          addToHistory(`ðŸ˜³ ${args} isn't ready for kisses yet.`, false);
        }
        drainEnergy(3);
        saveGame();
      },

      '/hug': (args) => {
        if (!args) {
          addToHistory('Usage: /hug [name]', false);
          return;
        }
        
        if (gameState.relationship !== 'stranger') {
          addToHistory(`ðŸ¤— You hugged ${args}! They seem happy.`, false);
          addXP(15);
        } else {
          addToHistory(`ðŸ˜• ${args} isn't ready for hugs yet.`, false);
        }
        drainEnergy(2);
        saveGame();
      },

      '/flirt': (args) => {
        if (!args) {
          addToHistory('Usage: /flirt [name]', false);
          return;
        }
        
        if (gameState.partnerName && gameState.partnerName !== args) {
          showPartnerReaction('flirt', args);
        }
        
        addToHistory(`ðŸ˜‰ You flirted with ${args}! They seem interested.`, false);
        addXP(20);
        drainEnergy(5);
        saveGame();
      },

      '/baby': (args) => {
         if (!args) {
            addToHistory('Usage: /baby [partner name] or /baby name [baby name]', false);
            return;
          }
          
          const subCommands = args.split(' ');
          if (subCommands[0] === 'name' && subCommands[1]) {
            // Naming existing baby
            const babyName = subCommands.slice(1).join(' ');
            if (gameState.children.length > 0) {
              const lastBaby = gameState.children[gameState.children.length - 1];
              if (lastBaby.name.startsWith('Baby-')) {
                lastBaby.name = babyName;
                addToHistory(`ðŸ‘¶ Baby renamed to ${babyName}!`, false);
                logEventToServer('baby_named', { babyName, parents: [lastBaby.parent1, lastBaby.parent2] });
              } else {
                addToHistory('No unnamed babies to name.', false);
              }
            } else {
              addToHistory('You have no children yet.', false);
            }
          } else {
            // Having baby with partner
            const partnerName = args;
            
            if (gameState.partnerName && gameState.partnerName !== partnerName) {
              showPartnerReaction('baby', partnerName);
            }
            
            // Show baby naming popup
            showBabyNamingPopup(partnerName);
          }
          saveGame();
},

      '/breakup': (args) => {
        if (!args) {
          addToHistory('Usage: /breakup [name]', false);
          return;
        }
        
        if (gameState.partnerName === args) {
          gameState.partnerName = null;
          gameState.relationship = 'friend';
          addToHistory(`ðŸ’” You broke up with ${args}. You're now single.`, false);
          addXP(10);
        } else {
          addToHistory(`ðŸ’” You're not in a relationship with ${args}.`, false);
        }
        saveGame();
      },
      '/children': (args) => {
          if (args === 'list') {
    if (gameState.children.length === 0) {
      addToHistory('ðŸ‘¶ You have no children yet. Use /baby [partner] to start a family!', false);
    } else {
      let list = `ðŸ‘¶ YOUR CHILDREN (${gameState.children.length}):\n\n`;
      gameState.children.forEach((child, index) => {
        const age = Math.floor((Date.now() - child.born) / (1000 * 60 * 60 * 24));
        list += `${index + 1}. ${child.name}\n`;
        list += `   Parents: ${child.parent1} & ${child.parent2}\n`;
        list += `   Age: ${age} Mars days old\n\n`;
      });
      addToHistory(list, false);
    }
  } else {
    addToHistory('Usage: /children list', false);
  }
},

      '/family': (args) => {
         if (args === 'tree') {
    let tree = 'ðŸŒ³ FAMILY TREE:\n\n';
    
    if (gameState.marriedTo) {
      tree += `ðŸ’‘ Married to: ${gameState.marriedTo}\n`;
    } else if (gameState.partnerName) {
      tree += `ðŸ’• Partner: ${gameState.partnerName}\n`;
    }
    
    if (gameState.children.length) {
      tree += `\nðŸ‘¶ Children (${gameState.children.length}):\n`;
      gameState.children.forEach((child, index) => {
        const age = Math.floor((Date.now() - child.born) / (1000 * 60 * 60 * 24));
        tree += `  ${index + 1}. ${child.name} (${age} days old)\n`;
      });
    }
    
    if (gameState.friends.length) {
      tree += `\nðŸ‘¥ Friends (${gameState.friends.length}):\n`;
      gameState.friends.forEach((friend, index) => {
        tree += `  ${index + 1}. ${friend.name} (${friend.type})\n`;
      });
    }
    
    if (!gameState.marriedTo && !gameState.partnerName && !gameState.children.length && !gameState.friends.length) {
      tree += 'Start your Mars family by making connections!\n';
      tree += 'Use /connect [name] to make friends\n';
      tree += 'Use /partner set [name] to find love';
    }
    
    addToHistory(tree, false);
    logEventToServer('family_tree_viewed', { 
      familySize: gameState.children.length + gameState.friends.length + (gameState.partnerName ? 1 : 0)
    });
  }
},

      '/friends': (args) => {
        if (args === 'list') {
          if (gameState.friends.length === 0) {
            addToHistory('ðŸ‘¥ You have no friends yet. Use /connect to make friends!', false);
          } else {
            const friendsList = gameState.friends.map(f => `${f.name} (${f.type})`).join(', ');
            addToHistory(`ðŸ‘¥ Your friends: ${friendsList}`, false);
          }
        }
      },

      '/build': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const target = subCommands?.slice(1).join(' ');
        
        if (action === 'home' && target) {
          addToHistory(`ðŸ  Building a home for ${target}... Construction started!`, false);
          gameState.resources.shelter += 20;
          addXP(75);
          drainEnergy(25);
        } else {
          const structures = ['solar_dome', 'habitat', 'greenhouse', 'landing_pad'];
          if (structures.includes(args)) {
            addToHistory(`ðŸ—ï¸ Building ${args.replace('_', ' ')}... Construction initiated!`, false);
            gameState.resources.shelter += 10;
            addXP(50);
            drainEnergy(20);
          } else {
            addToHistory('Usage: /build [home [name] | solar_dome | habitat | greenhouse | landing_pad]', false);
          }
        }
        saveGame();
      },

      '/energy': (args) => {
        if (args === 'status') {
          addToHistory(`âš¡ Current energy: ${Math.round(gameState.resources.energy)}%`, false);
        } else if (args === 'recharge') {
          showEnergyPopup();
        } else {
          addToHistory('Energy commands: status, recharge', false);
        }
      },

      '/credits': (args) => {
        const subCommands = args?.split(' ');
        const action = subCommands?.[0];
        const amount = parseInt(subCommands?.[1]) || 100;
        
        if (action === 'earn') {
          gameState.resources.credits += amount;
          addToHistory(`ðŸ’° Earned ${amount} credits!`, false);
          addXP(amount / 10);
          drainEnergy(5);
        } else {
          addToHistory(`ðŸ’° Current credits: ${gameState.resources.credits}`, false);
        }
        saveGame();
      },

      '/trade': (args) => {
        const subCommands = args?.split(' ');
        const resource = subCommands?.[0];
        const amount = parseInt(subCommands?.[1]) || 10;
        
        if (resource && gameState.resources[resource] !== undefined) {
          if (gameState.resources[resource] >= amount) {
            gameState.resources[resource] -= amount;
            gameState.resources.credits += amount * 5;
            addToHistory(`ðŸ’± Traded ${amount} ${resource} for ${amount * 5} credits!`, false);
            addXP(amount * 2);
            drainEnergy(5);
          } else {
            addToHistory(`âŒ Not enough ${resource} to trade.`, false);
          }
        } else {
          addToHistory('Usage: /trade [resource] [amount]', false);
        }
        saveGame();
      },

      '/mission': (args) => {
        if (gameState.resources.energy < 20) {
          addToHistory('âš ï¸ Not enough energy for missions! Recharge first.', false);
          showEnergyPopup();
          return;
        }
        
        const missions = {
          'explore': 'ðŸ§­ Exploration mission completed! Discovered new terrain.',
          'build': 'ðŸ—ï¸ Construction mission successful! Infrastructure improved.',
          'science': 'ðŸ”¬ Scientific research mission complete! Data collected.',
          'rescue': 'ðŸš‘ Rescue mission accomplished! Lives saved.'
        };
        
        if (missions[args]) {
          addToHistory(missions[args], false);
          addXP(40);
          drainEnergy(20);
          gameState.missions.push(args);
        } else {
          addToHistory('Available missions: ' + Object.keys(missions).join(', '), false);
        }
        saveGame();
      },

      '/minigame': (args) => {
         if (gameState.resources.energy < 10) {
            addToHistory('âš ï¸ Not enough energy for games! Recharge first.', false);
            showEnergyPopup();
            return;
          }
          
          const games = {
            'blackjack': 'black/blacko.html',
            'poker': 'poker/poke.html',
            'snake': 'snake/snake.html',
            'space': 'space/space.html',
            'xo': 'marxo/marxo.html',
            'word': 'marsword/word.html'
          };
          
          if (games[args]) {
            addToHistory(`ðŸŽ® Launching ${args}... Have fun!`, false);
            addXP(15);
            drainEnergy(10);
            
            logEventToServer('minigame_launched', { game: args, energy_cost: 10 });
            
            setTimeout(() => {
              window.location.href = games[args];
            }, 1000);
          } else {
            addToHistory('Available games: ' + Object.keys(games).join(', '), false);
          }
          saveGame();
        },

      '/explore': () => {
        if (gameState.resources.energy < 15) {
          addToHistory('âš ï¸ Not enough energy to explore! Recharge first.', false);
          showEnergyPopup();
          return;
        }
        
        const discoveries = [
          'ðŸ”´ Discovered ancient Martian ruins!',
          'ðŸ’Ž Found rare crystals in a cave!',
          'ðŸŒ¡ï¸ Located a natural heat source!',
          'ðŸ’§ Discovered underground water reserves!',
          'ðŸ‘½ Found signs of possible ancient life!'
        ];
        
        addToHistory(discoveries[Math.floor(Math.random() * discoveries.length)], false);
        addXP(35);
        drainEnergy(15);
        saveGame();
      },

      '/resources': (args) => {
        if (args === 'status') {
          const r = gameState.resources;
          addToHistory(`ðŸ“Š RESOURCE STATUS:
ðŸ’° Money: ${r.money} | ðŸ« Oxygen: ${r.oxygen}% | ðŸ’§ Water: ${r.water}L
ðŸ– Food: ${r.food} | ðŸ  Shelter: ${r.shelter} | âš¡ Energy: ${Math.round(r.energy)}%
â›½ Fuel: ${r.fuel}L | ðŸš— Rover: ${r.rover} | ðŸ’³ Credits: ${r.credits}
ðŸ’Ž Data Crystals: ${r.data_crystals}`, false);
          addXP(5);
        }
      },

      '/theme': (args) => {
        if (args === 'toggle') {
          toggleTheme();
        } else {
          addToHistory('Usage: /theme toggle', false);
        }
      },

      '/chat': (args) => {
        if (args === 'new') {
          clearChat();
        } else {
          addToHistory('Chat commands: new', false);
        }
      },

      '/save': () => {
        saveGame();
        addToHistory('ðŸ’¾ Game saved successfully.', false);
      },

      '/status': () => {
        addToHistory(`ðŸ“Š DETAILED STATUS:
ðŸ‘¤ Player: Level ${gameState.level} (${gameState.xp} XP)
ðŸ’• Relationship: ${gameState.relationship} with ${gameState.companionName}
${gameState.partnerName ? `ðŸ’– Partner: ${gameState.partnerName}` : ''}
${gameState.marriedTo ? `ðŸ’’ Married to: ${gameState.marriedTo}` : ''}
ðŸ‘¥ Friends: ${gameState.friends.length}
ðŸ‘¶ Children: ${gameState.children.length}
ðŸŽ¯ Missions completed: ${gameState.missions.length}
â° Session started: ${new Date(gameState.gameSession).toLocaleTimeString()}`, false);
      },
      '/jealousy': () => {
  if (!gameState.partnerName && !gameState.marriedTo) {
    addToHistory('ðŸ’” You need a partner first to experience jealousy.', false);
    return;
  }
  
  const partner = gameState.partnerName || gameState.marriedTo;
  const health = gameState.relationshipHealth || 100;
  const mood = gameState.partnerMood || 'happy';
  
  addToHistory(`ðŸ’ž RELATIONSHIP STATUS with ${partner}:
ðŸ’– Health: ${health}%
ðŸ˜Š Mood: ${mood}
${gameState.lastCheatingIncident ? 'âš ï¸ Recent incident needs addressing' : 'âœ… No trust issues'}`, false);
  
  logEventToServer('jealousy_checked', { partner, health, mood });
},

'/propose': (args) => {
  if (!args) {
    addToHistory('Usage: /propose [name]', false);
    return;
  }
  
  if (gameState.marriedTo) {
    addToHistory('ðŸ’’ You\'re already married! Divorce first if you want to remarry.', false);
    return;
  }
  
  if (gameState.partnerName && gameState.partnerName !== args) {
    enhancedPartnerReaction('marry', args);
  }
  
  showThinking();
  setTimeout(() => {
    if (Math.random() > 0.3) {
      addToHistory(`ðŸ’ ${args} said YES! You're engaged!`, false);
      gameState.engagedTo = args;
      gameState.relationship = 'engaged';
      addXP(150);
      logEventToServer('engagement', { partner: args, success: true });
    } else {
      addToHistory(`ðŸ’” ${args} said they need more time to think...`, false);
      addXP(25);
      logEventToServer('engagement', { partner: args, success: false });
    }
  }, 2000);
  
  drainEnergy(20);
  saveGame();
},

'/gift': (args) => {
  if (!args) {
    addToHistory('Usage: /gift [name]', false);
    return;
  }
  
  if (gameState.resources.credits < 50) {
    addToHistory('ðŸ’° Not enough credits for a gift! Need 50 credits.', false);
    return;
  }
  
  const gifts = [
    'ðŸŒ¹ Beautiful Mars roses',
    'ðŸ’Ž Rare Martian crystals', 
    'ðŸŽµ Custom love song',
    'ðŸ« Earth chocolate (imported)',
    'ðŸ–¼ï¸ Painted portrait of them'
  ];
  
  const gift = gifts[Math.floor(Math.random() * gifts.length)];
  gameState.resources.credits -= 50;
  
  addToHistory(`ðŸŽ You gave ${args} ${gift}! They're delighted!`, false);
  
  if (args === gameState.partnerName || args === gameState.marriedTo) {
    gameState.relationshipHealth = Math.min(100, (gameState.relationshipHealth || 0) + 15);
    gameState.partnerMood = 'happy';
  }
  
  addXP(40);
  drainEnergy(5);
  logEventToServer('gift_given', { recipient: args, gift, cost: 50 });
  saveGame();
},
'/affair': (args) => {
  if (!args) {
    addToHistory('Usage: /affair [name]', false);
    return;
  }
  
  if (!gameState.partnerName && !gameState.marriedTo) {
    addToHistory('ðŸ’” You need a partner first to have an affair!', false);
    return;
  }
  
  const partner = gameState.partnerName || gameState.marriedTo;
  enhancedPartnerReaction('affair', args);
  
  addToHistory(`ðŸ¤« You started a secret affair with ${args}...`, false);
  
  showThinking();
  setTimeout(() => {
    if (Math.random() > 0.4) {
      addToHistory(`ðŸ’• Your secret relationship with ${args} is passionate but dangerous!`, false);
      gameState.secretAffairs = gameState.secretAffairs || [];
      gameState.secretAffairs.push({ name: args, started: Date.now() });
      addXP(75);
      
      trackRelationshipEvent('affair_started', { lover: args, partner });
    } else {
      addToHistory(`ðŸ˜° ${args} rejected your advances. They respect your relationship.`, false);
      addXP(15);
      
      trackRelationshipEvent('affair_rejected', { target: args, partner });
    }
  }, 2500);
  
  drainEnergy(25);
  saveGame();
},

'/confess': (args) => {
  if (!gameState.secretAffairs || gameState.secretAffairs.length === 0) {
    addToHistory('ðŸ’¯ You have nothing to confess. You\'re innocent!', false);
    return;
  }
  
  const partner = gameState.partnerName || gameState.marriedTo;
  if (!partner) {
    addToHistory('ðŸ’” No partner to confess to.', false);
    return;
  }
  
  const affair = gameState.secretAffairs[0];
  addToHistory(`ðŸ˜­ You confessed your affair with ${affair.name} to ${partner}...`, false);
  
  showThinking();
  setTimeout(() => {
    gameState.relationshipHealth = Math.max(0, (gameState.relationshipHealth || 100) - 40);
    gameState.partnerMood = 'devastated';
    gameState.secretAffairs = [];
    
    if (gameState.relationshipHealth < 20) {
      addToHistory(`ðŸ’” ${partner} broke up with you! "I can't trust you anymore!"`, false);
      gameState.partnerName = null;
      gameState.marriedTo = null;
      gameState.relationship = 'single';
    } else {
      addToHistory(`ðŸ˜¢ ${partner} is devastated but willing to work on the relationship...`, false);
    }
    
    trackRelationshipEvent('affair_confessed', { 
      affair, 
      partner, 
      relationshipSurvived: gameState.relationshipHealth >= 20 
    });
    
    addXP(50); // XP for honesty
  }, 3000);
  
  saveGame();
},
'/swingers': () => {
  if (!gameState.partnerName && !gameState.marriedTo) {
    addToHistory('ðŸ’” You need a partner to join the swinger lifestyle!', false);
    return;
  }
  
  const partner = gameState.partnerName || gameState.marriedTo;
  addToHistory(`ðŸ”„ You suggest to ${partner} that you both explore swinging...`, false);
  
  showThinking();
  setTimeout(() => {
    if (Math.random() > 0.6) {
      addToHistory(`ðŸ˜ˆ ${partner} is intrigued! "Let's explore together!"`, false);
      gameState.lifestyle = 'swingers';
      gameState.relationshipHealth = Math.min(100, (gameState.relationshipHealth || 100) + 10);
      addXP(100);
      
      trackRelationshipEvent('lifestyle_change', { newLifestyle: 'swingers', partner });
    } else {
      addToHistory(`ðŸ˜ ${partner} isn't comfortable with that idea right now.`, false);
      addXP(25);
      
      trackRelationshipEvent('lifestyle_rejected', { proposedLifestyle: 'swingers', partner });
    }
  }, 2500);
  
  drainEnergy(15);
  saveGame();
},

'/polyamory': (args) => {
  if (!args) {
    addToHistory('Usage: /polyamory [partner2_name]', false);
    return;
  }
  
  if (!gameState.partnerName && !gameState.marriedTo) {
    addToHistory('ðŸ’” You need at least one partner first!', false);
    return;
  }
  
  const primaryPartner = gameState.partnerName || gameState.marriedTo;
  addToHistory(`ðŸ’• You propose polyamory to ${primaryPartner}, wanting to include ${args}...`, false);
  
  showThinking();
  setTimeout(() => {
    if (Math.random() > 0.5) {
      addToHistory(`ðŸŒˆ ${primaryPartner} agrees! You're now in a polyamorous relationship with ${args}!`, false);
      gameState.polyPartners = gameState.polyPartners || [];
      gameState.polyPartners.push(args);
      gameState.relationship = 'polyamorous';
      addXP(150);
      
      trackRelationshipEvent('polyamory_started', { 
        primaryPartner, 
        newPartner: args 
      });
    } else {
      addToHistory(`ðŸ˜” ${primaryPartner} needs time to think about this...`, false);
      gameState.relationshipHealth = Math.max(0, (gameState.relationshipHealth || 100) - 15);
      addXP(30);
      
      trackRelationshipEvent('polyamory_rejected', { 
        primaryPartner, 
        proposedPartner: args 
      });
    }
  }, 3000);
  
  drainEnergy(20);
  saveGame();
},

'/scandal': () => {
  addToHistory(`ðŸ“° MARS COLONY GOSSIP NETWORK`, false);
  
  const scandals = [
    `ðŸ”¥ Rumor: Someone was seen sneaking between habitats at night...`,
    `ðŸ’‹ Gossip: Multiple colonists spotted in compromising positions!`,
    `ðŸ˜± Scandal: Secret love triangle discovered in the greenhouse!`,
    `ðŸ¤« Whisper: Underground dating ring operating in the mining tunnels!`,
    `ðŸ’ Drama: Someone's planning a secret wedding without telling their current partner!`
  ];
  
  if (gameState.secretAffairs && gameState.secretAffairs.length > 0) {
    scandals.push(`ðŸ•µï¸ Your affair with ${gameState.secretAffairs[0].name} is becoming colony gossip!`);
  }
  
  if (gameState.polyPartners && gameState.polyPartners.length > 0) {
    scandals.push(`ðŸ‘¥ Your polyamorous relationship is the talk of the colony!`);
  }
  
  const scandal = scandals[Math.floor(Math.random() * scandals.length)];
  addToHistory(scandal, false);
  
  addXP(10);
  drainEnergy(2);
  
  logEventToServer('scandal_viewed', { scandalType: scandal });
},
'/divorce_court': () => {
  if (!gameState.marriedTo) {
    addToHistory('âš–ï¸ You\'re not married, no need for divorce court!', false);
    return;
  }
  
  addToHistory(`âš–ï¸ MARS COLONY DIVORCE PROCEEDINGS`, false);
  addToHistory(`ðŸ›ï¸ You vs. ${gameState.marriedTo}`, false);
  
  showThinking();
  setTimeout(() => {
    const courtOutcomes = [
      { 
        message: `âš–ï¸ Court rules in your favor! You keep 70% of shared resources.`,
        creditsChange: Math.floor(gameState.resources.credits * 0.2)
      },
      { 
        message: `ðŸ’¸ Court rules against you. You must pay alimony.`,
        creditsChange: -Math.floor(gameState.resources.credits * 0.3)
      },
      { 
        message: `âš–ï¸ Amicable settlement reached. Assets split 50/50.`,
        creditsChange: 0
      }
    ];
    
    const outcome = courtOutcomes[Math.floor(Math.random() * courtOutcomes.length)];
    addToHistory(outcome.message, false);
    
    gameState.resources.credits = Math.max(0, gameState.resources.credits + outcome.creditsChange);
    gameState.marriedTo = null;
    gameState.relationship = 'divorced';
    
    trackRelationshipEvent('divorce_finalized', {
      exSpouse: gameState.marriedTo,
      financialOutcome: outcome.creditsChange,
      courtRuling: outcome.message
    });
    
    addXP(100);
  }, 4000);
  
  drainEnergy(30);
  saveGame();
},

'/reputation': () => {
  const reputation = gameState.reputation || 50;
  let reputationStatus;
  
  if (reputation < 20) {
    reputationStatus = "Notorious Troublemaker ðŸ˜ˆ";
  } else if (reputation < 40) {
    reputationStatus = "Questionable Character ðŸ¤¨";
  } else if (reputation < 60) {
    reputationStatus = "Average Colonist ðŸ˜";
  } else if (reputation < 80) {
    reputationStatus = "Respected Member ðŸ˜Š";
  } else {
    reputationStatus = "Colony Hero ðŸ‘‘";
  }
  
  addToHistory(`ðŸ“Š YOUR MARS COLONY REPUTATION:
ðŸ† Status: ${reputationStatus}
ðŸ“ˆ Score: ${reputation}/100

Recent Activities:
${gameState.secretAffairs ? `ðŸ¤« Secret Affairs: ${gameState.secretAffairs.length}` : ''}
${gameState.children.length > 0 ? `ðŸ‘¶ Children: ${gameState.children.length}` : ''}
${gameState.friends.length > 0 ? `ðŸ‘¥ Friends: ${gameState.friends.length}` : ''}
${gameState.polyPartners ? `ðŸ’• Poly Partners: ${gameState.polyPartners.length}` : ''}`, false);
  
  addXP(5);
  logEventToServer('reputation_checked', { reputation, status: reputationStatus });
},

'/therapy': () => {
  if (gameState.resources.credits < 100) {
    addToHistory('ðŸ’° Therapy costs 100 credits. Mental health is expensive on Mars!', false);
    return;
  }
  
  gameState.resources.credits -= 100;
  addToHistory(`ðŸ›‹ï¸ You attend a therapy session with Dr. Martinez...`, false);
  
  showThinking();
  setTimeout(() => {
    gameState.relationshipHealth = Math.min(100, (gameState.relationshipHealth || 50) + 30);
    gameState.partnerMood = gameState.partnerMood === 'furious' ? 'hurt_but_forgiving' : 'happy';
    gameState.mentalHealth = Math.min(100, (gameState.mentalHealth || 50) + 40);
    
    addToHistory(`ðŸ’š Therapy helps! You feel more balanced and your relationships improve.`, false);
    addToHistory(`ðŸ§  Mental Health: ${gameState.mentalHealth}% | Relationship Health: ${gameState.relationshipHealth}%`, false);
    
    trackRelationshipEvent('therapy_session', {
      cost: 100,
      mentalHealthGain: 40,
      relationshipHealthGain: 30
    });
    
    addXP(75);
  }, 3000);
  
  drainEnergy(10);
  saveGame();
},

'/drunk': () => {
  if (gameState.resources.credits < 25) {
    addToHistory('ðŸº You need 25 credits for Mars moonshine!', false);
    return;
  }
  
  gameState.resources.credits -= 25;
  gameState.isDrunk = true;
  
  addToHistory(`ðŸ» You drink some potent Mars moonshine... everything feels fuzzy!`, false);
  
  // Drunk commands have different effects
  setTimeout(() => {
    const drunkActions = [
      `ðŸ˜µ You confess your love to your companion's reflection!`,
      `ðŸ¤ª You try to call Earth but end up talking to a rover!`,
      `ðŸ˜‚ You think the red soil is talking to you!`,
      `ðŸŽ¤ You sing love songs to the Martian sunset!`
    ];
    
    const action = drunkActions[Math.floor(Math.random() * drunkActions.length)];
    addToHistory(action, false);
    
    logEventToServer('drunk_behavior', { action, cost: 25 });
    addXP(20);
    
    // Sober up after some time
    setTimeout(() => {
      gameState.isDrunk = false;
      addToHistory(`ðŸ˜… You sober up and remember why Mars colonists should drink responsibly...`, false);
    }, 120000); // 2 minutes
  }, 1000);
  
  drainEnergy(15);
  saveGame();
},



'/stalk': (args) => {
  if (!args) {
    addToHistory('Usage: /stalk [name]', false);
    return;
  }
  
  addToHistory(`ðŸ•µï¸ You carefully observe ${args} from a distance...`, false);
  
  showThinking();
  setTimeout(() => {
    const observations = [
      `${args} likes to watch Earth rise over the Mars horizon`,
      `${args} has a secret stash of Earth snacks in their habitat`,
      `${args} talks to their plants in the greenhouse`,
      `${args} practices zero-gravity dancing when alone`,
      `${args} writes poetry about Mars sunsets`
    ];
    
    const observation = observations[Math.floor(Math.random() * observations.length)];
    addToHistory(`ðŸ‘ï¸ You discovered: ${observation}`, false);
    
    if (Math.random() > 0.7) {
      addToHistory(`ðŸ˜± ${args} noticed you watching! They seem uncomfortable...`, false);
      if (args === gameState.partnerName || args === gameState.marriedTo) {
        gameState.relationshipHealth = Math.max(0, (gameState.relationshipHealth || 100) - 10);
      }
      logEventToServer('stalking_caught', { target: args });
    } else {
      logEventToServer('stalking_successful', { target: args, observation });
    }
  }, 2500);
  
  addXP(15);
  drainEnergy(10);
  saveGame();
}
    };
    
//     function showSuggestions(input) {
//   const suggestions = document.getElementById('suggestions');
//   suggestions.innerHTML = '';
  
//   if (!input.startsWith('/')) {
//     suggestions.style.display = 'none';
//     return;
//   }
  
//   const inputParts = input.split(' ');
//   const command = inputParts[0];
//   const availableCommands = Object.keys(commands).filter(cmd => cmd.startsWith(command));
  
//   if (availableCommands.length > 0) {
//     suggestions.style.display = 'block'; // Change from classList.add('active')
//     availableCommands.forEach(cmd => {
//       const item = document.createElement('div');
//       item.className = 'suggestion-item';
//       item.textContent = cmd;
//       item.addEventListener('click', () => {
//         document.getElementById('terminalInput').value = cmd + ' ';
//         suggestions.style.display = 'none';
//         document.getElementById('terminalInput').focus();
//       });
//       suggestions.appendChild(item);
//     });
//   } else {
//     suggestions.style.display = 'none'; // Change from classList.remove('active')
//   }
// }

//     function showSuggestions(input) {
//   const suggestions = document.getElementById('suggestions');
//   const terminalInput = document.getElementById('terminalInput');

//   suggestions.innerHTML = '';

//   if (!input.startsWith('/')) {
//     suggestions.style.display = 'none';
//     return;
//   }

//   const inputParts = input.split(' ');
//   const command = inputParts[0];
//   const availableCommands = Object.keys(commands).filter(cmd => cmd.startsWith(command));

//   if (availableCommands.length > 0) {
//     suggestions.style.display = 'block';

//     availableCommands.forEach(cmd => {
//       const item = document.createElement('div');
//       item.className = 'suggestion-item';
//       item.textContent = cmd;

//       // Support for both touch and mouse
//       const selectCommand = (e) => {
//         e.preventDefault(); // Prevent input blur on mobile
//         terminalInput.value = cmd + ' ';
//         suggestions.innerHTML = '';
//         suggestions.style.display = 'none';
//         terminalInput.focus();
//       };

//       item.addEventListener('mousedown', selectCommand);
//       item.addEventListener('touchstart', selectCommand);

//       suggestions.appendChild(item);
//     });
//   } else {
//     suggestions.style.display = 'none';
//   }
// }
// function showSuggestions(input, isTerminalMode = false) {
//   const suggestionsContainer = isTerminalMode 
//     ? document.getElementById('terminalSuggestions')
//     : document.getElementById('suggestions');
    
//   const inputElement = isTerminalMode 
//     ? document.getElementById('terminalCommandInput')
//     : document.getElementById('terminalInput');
  
//   suggestionsContainer.innerHTML = '';
  
//   if (!input.startsWith('/')) {
//     suggestionsContainer.style.display = 'none';
//     return;
//   }
  
//   const inputParts = input.split(' ');
//   const command = inputParts[0];
//   const availableCommands = Object.keys(commands).filter(cmd => cmd.startsWith(command));
  
//   if (availableCommands.length > 0) {
//     suggestionsContainer.style.display = 'block';
//     availableCommands.forEach(cmd => {
//       const item = document.createElement('div');
//       item.className = 'suggestion-item';
//       item.textContent = cmd;
//       item.addEventListener('click', () => {
//         inputElement.value = cmd + ' ';
//         suggestionsContainer.style.display = 'none';
//         inputElement.focus();
//       });
//       suggestionsContainer.appendChild(item);
//     });
//   } else {
//     suggestionsContainer.style.display = 'none';
//   }
// }
function showSuggestions(input, isTerminalMode = false) {
  const suggestionsContainer = isTerminalMode 
    ? document.getElementById('terminalSuggestions')
    : document.getElementById('suggestions');
    
  const inputElement = isTerminalMode 
    ? document.getElementById('terminalCommandInput')
    : document.getElementById('terminalInput');
  
  suggestionsContainer.innerHTML = '';
  
  if (!input.startsWith('/')) {
    suggestionsContainer.style.display = 'none';
    return;
  }
  
  const inputParts = input.split(' ');
  const command = inputParts[0];
  const availableCommands = Object.keys(commands).filter(cmd => cmd.startsWith(command));
  
  if (availableCommands.length > 0) {
    suggestionsContainer.style.display = 'block';
    
    availableCommands.forEach(cmd => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.style.cssText = `
        padding: 8px 12px;
        margin: 2px 0;
        background: rgba(0, 255, 153, 0.1);
        border: 1px solid rgba(0, 255, 153, 0.3);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      `;
      
      item.textContent = cmd;
      
      item.addEventListener('mouseenter', () => {
        item.style.background = 'rgba(0, 255, 153, 0.2)';
      });
      
      item.addEventListener('mouseleave', () => {
        item.style.background = 'rgba(0, 255, 153, 0.1)';
      });
      
      item.addEventListener('click', () => {
        inputElement.value = cmd + ' ';
        suggestionsContainer.style.display = 'none';
        inputElement.focus();
      });
      
      suggestionsContainer.appendChild(item);
    });
  } else {
    suggestionsContainer.style.display = 'none';
  }
}
//   const commandDescriptions = {
//   '/help': 'Show all available commands',
//   '/nav': 'Navigate to different pages',
//   '/connect': 'Connect with a companion',
//   '/companion': 'Interact with your companion',
//   '/partner': 'Manage romantic relationships',
//   '/marry': 'Propose marriage',
//   '/energy': 'Check or recharge energy',
//   '/credits': 'Manage credits',
//   '/mission': 'Start a mission',
//   '/explore': 'Explore Mars',
//   '/theme': 'Toggle between chat/terminal modes',
//   // Add more as needed
// };


function showBabyNamingPopup(partnerName) {
  const modal = document.createElement('div');
  modal.className = 'popup-overlay';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="popup">
      <h3><i class="fas fa-baby"></i> Welcome to Mars, Little One!</h3>
      <p>You're having a baby with ${partnerName}!</p>
      <input type="text" id="babyNameInput" placeholder="Enter baby's name" 
             class="mallo" style="width: 100%; margin: 1rem 0;">
      <div class="popup-buttons">
        <button class="popup-btn primary" onclick="confirmBabyName('${partnerName}')">
          <i class="fas fa-heart"></i> Confirm
        </button>
        <button class="popup-btn secondary" onclick="this.closest('.popup-overlay').remove()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  setTimeout(() => {
    document.getElementById('babyNameInput').focus();
  }, 100);
}

function confirmBabyName(partnerName) {
  const babyName = document.getElementById('babyNameInput').value.trim() || 
                  `Baby ${Math.random().toString(36).substr(2, 5)}`;
  
  const baby = {
    name: babyName,
    parent1: 'You',
    parent2: partnerName,
    born: Date.now(),
    age: 0,
    id: Date.now().toString()
  };
  
  gameState.children.push(baby);
  addToHistory(`ðŸ‘¶ Congratulations! Welcome ${babyName} to the Mars colony!`, false);
  addXP(200);
  drainEnergy(20);
  
  logEventToServer('baby_born', { baby, parents: [baby.parent1, baby.parent2] });
  
  document.querySelectorAll('.popup-overlay').forEach(m => m.remove());
  saveGame();
}

// Admin cheat system
class AdminCheatManager {
  constructor() {
    this.touchSequence = [];
    this.adminMode = false;
    this.secretSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'KeyA', 'KeyD', 'KeyM', 'KeyI', 'KeyN'];
    this.keySequence = [];
    this.initializeGestures();
  }

  initializeGestures() {
    let touchStart = null;
    let touchCount = 0;
    
    // Touch gestures for mobile admin
    document.addEventListener('touchstart', (e) => {
      touchStart = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
        time: Date.now()
      };
    });
    
    document.addEventListener('touchend', (e) => {
      if (!touchStart) return;
      
      const touchEnd = {
        x: e.changedTouches[0].clientX,
        y: e.changedTouches[0].clientY,
        time: Date.now()
      };
      
      const deltaX = touchEnd.x - touchStart.x;
      const deltaY = touchEnd.y - touchStart.y;
      const deltaTime = touchEnd.time - touchStart.time;
      
      // Four corners tap sequence: top-left, top-right, bottom-left, bottom-right
      if (deltaTime < 300 && Math.abs(deltaX) < 50 && Math.abs(deltaY) < 50) {
        const corner = this.getScreenCorner(touchStart);
        this.touchSequence.push(corner);
        
        if (this.touchSequence.length > 4) {
          this.touchSequence = this.touchSequence.slice(-4);
        }
        
        // Check for admin sequence: top-left, top-right, bottom-left, bottom-right
        if (this.touchSequence.join('-') === 'tl-tr-bl-br') {
          this.activateAdminMode();
          this.touchSequence = [];
        }
      }
    });
    
    // Keyboard sequence for desktop admin
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;
      
      this.keySequence.push(e.code);
      if (this.keySequence.length > 9) {
        this.keySequence = this.keySequence.slice(-9);
      }
      
      if (this.keySequence.join('-') === this.secretSequence.join('-')) {
        this.activateAdminMode();
        this.keySequence = [];
      }
    });
  }
  
  getScreenCorner(touch) {
    const w = window.innerWidth;
    const h = window.innerHeight;
    const x = touch.x;
    const y = touch.y;
    
    if (x < w/3 && y < h/3) return 'tl'; // top-left
    if (x > 2*w/3 && y < h/3) return 'tr'; // top-right
    if (x < w/3 && y > 2*h/3) return 'bl'; // bottom-left
    if (x > 2*w/3 && y > 2*h/3) return 'br'; // bottom-right
    return 'center';
  }
  
  activateAdminMode() {
    this.adminMode = true;
    this.showAdminPanel();
    addToHistory('ðŸ›¡ï¸ Admin mode activated!', false, 'system');
    logEventToServer('admin_mode_activated', { timestamp: new Date().toISOString() });
  }
  
  showAdminPanel() {
    const modal = document.createElement('div');
    modal.className = 'popup-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="popup" style="max-width: 500px;">
        <h3><i class="fas fa-user-shield"></i> Admin Panel</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 1rem 0;">
          <button class="popup-btn primary" onclick="adminCheatManager.addXP(1000)">+1000 XP</button>
          <button class="popup-btn primary" onclick="adminCheatManager.addCredits(5000)">+5000 Credits</button>
          <button class="popup-btn primary" onclick="adminCheatManager.fullEnergy()">Full Energy</button>
          <button class="popup-btn primary" onclick="adminCheatManager.maxResources()">Max Resources</button>
          <button class="popup-btn primary" onclick="adminCheatManager.unlockAll()">Unlock All</button>
          <button class="popup-btn primary" onclick="adminCheatManager.triggerEvent()">Trigger Event</button>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn secondary" onclick="this.closest('.popup-overlay').remove()">
            Close
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  addXP(amount) {
    addXP(amount);
    addToHistory(`ðŸ›¡ï¸ Admin granted ${amount} XP`, false, 'system');
    logEventToServer('admin_cheat', { type: 'xp', amount });
  }
  
  addCredits(amount) {
    gameState.resources.credits += amount;
    addToHistory(`ðŸ›¡ï¸ Admin granted ${amount} credits`, false, 'system');
    logEventToServer('admin_cheat', { type: 'credits', amount });
    saveGame();
  }
  
  fullEnergy() {
    gameState.resources.energy = 100;
    addToHistory('ðŸ›¡ï¸ Admin restored full energy', false, 'system');
    logEventToServer('admin_cheat', { type: 'energy', amount: 100 });
    saveGame();
  }
  
  maxResources() {
    Object.keys(gameState.resources).forEach(key => {
      if (typeof gameState.resources[key] === 'number') {
        gameState.resources[key] = key === 'energy' ? 100 : 9999;
      }
    });
    addToHistory('ðŸ›¡ï¸ Admin maxed all resources', false, 'system');
    logEventToServer('admin_cheat', { type: 'max_resources' });
    saveGame();
  }
  
  unlockAll() {
    gameState.achievements = ['Explorer', 'Builder', 'Lover', 'Parent', 'Leader', 'Hero'];
    addToHistory('ðŸ›¡ï¸ Admin unlocked all achievements', false, 'system');
    logEventToServer('admin_cheat', { type: 'unlock_all' });
    saveGame();
  }
  
  triggerEvent() {
    const events = ['cyborg', 'companion', 'visitor'];
    const event = events[Math.floor(Math.random() * events.length)];
    
    switch(event) {
      case 'cyborg':
        triggerCyborgPopup();
        break;
      case 'companion':
        triggerCompanionPopup();
        break;
      case 'visitor':
        generateVisitor();
        break;
    }
    
    logEventToServer('admin_trigger_event', { event });
  }
}

// Initialize admin system
const adminCheatManager = new AdminCheatManager();


function showTerminalSuggestions(input) {
  const suggestionsContainer = document.getElementById('terminalSuggestions');
  const inputElement = document.getElementById('terminalCommandInput');
  
  suggestionsContainer.innerHTML = '';
  
  if (!input.startsWith('/')) {
    suggestionsContainer.classList.remove('active');
    return;
  }
  
  const inputParts = input.split(' ');
  const command = inputParts[0];
  const availableCommands = Object.keys(commands).filter(cmd => cmd.startsWith(command));
  
  if (availableCommands.length > 0) {
    suggestionsContainer.classList.add('active');
    availableCommands.forEach(cmd => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #00ff99; font-weight: bold;">${cmd}</span>
          <span style="color: #888; font-size: 0.75rem; font-style: italic;">
            ${commandDescriptions[cmd] || 'Command'}
          </span>
        </div>
      `;
      
      item.addEventListener('click', () => {
        inputElement.value = cmd + ' ';
        suggestionsContainer.classList.remove('active');
        inputElement.focus();
      });
      suggestionsContainer.appendChild(item);
    });
  } else {
    suggestionsContainer.classList.remove('active');
  }
}

// Ensure event listener is attached
document.getElementById('terminalCommandInput').addEventListener('input', (e) => {
  showTerminalSuggestions(e.target.value.trim());
});

// Update event listeners
document.getElementById('terminalInput').addEventListener('input', (e) => {
  showSuggestions(e.target.value.trim(), false); // Chat mode
});

// document.getElementById('terminalCommandInput').addEventListener('input', (e) => {
//   showTerminalSuggestions(e.target.value.trim());
// });

// Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
  const chatSuggestions = document.getElementById('suggestions');
  const terminalSuggestions = document.getElementById('terminalSuggestions');
  const chatInput = document.getElementById('terminalInput');
  const terminalInput = document.getElementById('terminalCommandInput');
  
  if (!chatInput.contains(e.target) && !chatSuggestions.contains(e.target)) {
    chatSuggestions.style.display = 'none';
  }
  
  if (!terminalInput.contains(e.target) && !terminalSuggestions.contains(e.target)) {
    terminalSuggestions.classList.remove('active');
  }
});

document.addEventListener('mousedown', function(e) {
  if (!e.target.closest('#suggestions') && e.target.id !== 'terminalInput') {
    document.getElementById('suggestions').style.display = 'none';
  }
});

document.addEventListener('touchstart', function(e) {
  if (!e.target.closest('#suggestions') && e.target.id !== 'terminalInput') {
    document.getElementById('suggestions').style.display = 'none';
  }
});

    function processCommand(input) {
      if (input.startsWith('/')) {
        const [command, ...args] = input.split(' ');
        const cmdFunction = commands[command.toLowerCase()];
        if (cmdFunction) {
          cmdFunction(args.join(' ').toLowerCase());
        } else {
          addToHistory(`âŒ Unknown command '${command}'. Type /help for available commands.`, false);
        }
      } else if (input) {
        addToHistory(`${gameState.companionName}: I understand commands starting with /. Try /help!`, false);
      }
    }

    function toggleTheme(save = true) {
      isTerminalMode = !isTerminalMode;
      document.body.classList.toggle('terminal-mode', isTerminalMode);
      document.body.classList.toggle('chat-mode', !isTerminalMode);
      
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.innerHTML = isTerminalMode 
        ? '<i class="fas fa-comments"></i><span>Chat</span>' 
        : '<i class="fas fa-code"></i><span>Terminal</span>';
      
      if (save) {
        gameState.theme = isTerminalMode ? 'terminal' : 'chat';
        saveGame();
      }
      
      if (isTerminalMode) {
        setTimeout(() => {
          document.getElementById('terminalCommandInput').focus();
        }, 100);
      }
    }

    // Event Listeners
    document.getElementById('themeToggle').addEventListener('click', () => toggleTheme());

    document.getElementById('newChatBtn').addEventListener('click', clearChat);

    document.getElementById('runBtn').addEventListener('click', () => {
      const input = document.getElementById('terminalCommandInput').value.trim();
      if (input) {
        addToHistory(input, true);
        processCommand(input);
        document.getElementById('terminalCommandInput').value = '';
      }
    });

    document.getElementById('terminalCommandInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('runBtn').click();
      }
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const input = document.getElementById('terminalInput').value.trim();
      if (input) {
        addToHistory(input, true);
        processCommand(input);
        document.getElementById('terminalInput').value = '';
      }
    });

    document.getElementById('terminalInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('sendBtn').click();
      }
    });
    document.getElementById('terminalInput').addEventListener('input', (e) => {
  showSuggestions(e.target.value.trim());
});

//     document.getElementById('terminalCommandInput').addEventListener('input', (e) => {
//   // You could show suggestions for terminal mode too if desired
//   showSuggestions(e.target.value.trim());
// });
    // Close popups when clicking outside
    document.querySelectorAll('.popup-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });
    });

    // Auto-save every 30 seconds
    setInterval(saveGame, 30000);

    // Initialize welcome message
    setTimeout(() => {
      if (gameState.chatHistory.length <= 1) {
        addToHistory(`Welcome back to Mars, Commander! I'm ${gameState.companionName}, your AI companion.`, false);
        addToHistory(`Your energy is at ${Math.round(gameState.resources.energy)}%. Type /help to see what we can do together!`, false);
      }
    }, 1000);
  </script>
  <script>
    // Admin Integration Bridge - Add this to your main game file (marzo.html or me.html)
class MarsoVersePlayerManager {
  constructor() {
    this.playerId = null;
    this.playerProfile = null;
    this.adminChannel = null;
    this.init();
  }

  async init() {
    await this.initializePlayer();
    this.setupAdminBridge();
    this.startPeriodicSync();
  }

  async initializePlayer() {
    // Generate player ID from wallet or create anonymous
    const walletAddress = localStorage.getItem('walletAddress');
    if (walletAddress) {
      this.playerId = await this.generatePlayerId(walletAddress);
    } else {
      this.playerId = this.generateAnonymousId();
    }

    // Load or create player profile
    this.playerProfile = this.loadPlayerProfile();
    localStorage.setItem('currentPlayerId', this.playerId);
    
    // Sync with admin
    this.syncWithAdmin('player_login', {
      playerId: this.playerId,
      profile: this.playerProfile
    });
  }

  generateAnonymousId() {
    return 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  async generatePlayerId(walletAddress) {
    let hash = 0;
    for (let i = 0; i < walletAddress.length; i++) {
      const char = walletAddress.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return 'player_' + Math.abs(hash).toString(36);
  }

  loadPlayerProfile() {
    // Check if player exists in admin system first
    const adminPlayers = JSON.parse(localStorage.getItem('marsoverse_players') || '[]');
    const existingPlayer = adminPlayers.find(p => p.id === this.playerId || p.name === localStorage.getItem('playerName'));
    
    if (existingPlayer) {
      return this.convertFromAdminFormat(existingPlayer);
    }

    // Create new profile compatible with admin system
    const profile = {
      id: this.playerId,
      name: localStorage.getItem('playerName') || `Explorer_${this.playerId.slice(-6)}`,
      age: parseInt(localStorage.getItem('playerAge')) || 25,
      xp: parseInt(localStorage.getItem('playerXP')) || 0,
      companion: localStorage.getItem('companionName') || 'Elena',
      cyborg: localStorage.getItem('cyborgName') || 'Jeremy',
      wallet: parseFloat(localStorage.getItem('walletBalance')) || 0,
      status: 'online',
      lastActive: new Date().toISOString(),
      createdAt: new Date().toISOString(),
      // Game-specific data
      gameData: {
        level: gameState?.level || 1,
        energy: gameState?.resources?.energy || 100,
        credits: gameState?.resources?.credits || 1000,
        relationship: gameState?.relationship || 'stranger',
        achievements: gameState?.achievements || [],
        missions: gameState?.missions || []
      }
    };

    this.addToAdminSystem(profile);
    return profile;
  }

  convertFromAdminFormat(adminPlayer) {
    return {
      id: adminPlayer.id,
      name: adminPlayer.name,
      age: adminPlayer.age,
      xp: adminPlayer.xp,
      companion: adminPlayer.companion,
      cyborg: adminPlayer.cyborg,
      wallet: adminPlayer.wallet,
      status: adminPlayer.status,
      lastActive: adminPlayer.lastActive,
      createdAt: adminPlayer.createdAt,
      gameData: adminPlayer.gameData || {}
    };
  }

  addToAdminSystem(profile) {
    const adminPlayers = JSON.parse(localStorage.getItem('marsoverse_players') || '[]');
    
    // Check if player already exists
    const existingIndex = adminPlayers.findIndex(p => p.id === profile.id);
    
    if (existingIndex >= 0) {
      // Update existing player
      adminPlayers[existingIndex] = {
        ...adminPlayers[existingIndex],
        ...profile,
        lastActive: new Date().toISOString()
      };
    } else {
      // Add new player
      adminPlayers.push(profile);
    }
    
    localStorage.setItem('marsoverse_players', JSON.stringify(adminPlayers));
  }

  updateStats() {
    if (!this.playerProfile) return;

    // Update profile with current game state
    this.playerProfile.xp = parseInt(localStorage.getItem('playerXP')) || 0;
    this.playerProfile.wallet = parseFloat(localStorage.getItem('walletBalance')) || 0;
    this.playerProfile.lastActive = new Date().toISOString();
    this.playerProfile.status = 'online';
    
    if (typeof gameState !== 'undefined') {
      this.playerProfile.gameData = {
        level: gameState.level || 1,
        energy: gameState.resources?.energy || 100,
        credits: gameState.resources?.credits || 1000,
        relationship: gameState.relationship || 'stranger',
        achievements: gameState.achievements || [],
        missions: gameState.missions || []
      };
    }

    // Update admin system
    this.addToAdminSystem(this.playerProfile);
  }

  logPurchase(packType, amount, txHash = null) {
    const purchase = {
      id: Date.now(),
      playerId: this.playerId,
      playerName: this.playerProfile.name,
      packType,
      amount,
      txHash,
      timestamp: new Date().toISOString(),
      walletAddress: localStorage.getItem('walletAddress')
    };

    // Log to admin system
    const purchases = JSON.parse(localStorage.getItem('marsoverse_purchases') || '[]');
    purchases.push(purchase);
    localStorage.setItem('marsoverse_purchases', JSON.stringify(purchases));

    // Update player wallet balance
    this.playerProfile.wallet += amount;
    this.updateStats();

    // Notify admin
    this.syncWithAdmin('purchase_made', purchase);
  }

  setupAdminBridge() {
    // Setup BroadcastChannel if available
    if (typeof BroadcastChannel !== 'undefined') {
      this.adminChannel = new BroadcastChannel('marsoverse_admin');
      
      this.adminChannel.addEventListener('message', (event) => {
        this.handleAdminMessage(event.data);
      });
    }

    // Listen for admin commands via localStorage
    window.addEventListener('storage', (e) => {
      if (e.key === 'marsoverse_admin_command') {
        const command = JSON.parse(e.newValue || '{}');
        this.handleAdminCommand(command);
      }
    });
  }

  handleAdminMessage(data) {
    if (data.playerId && data.playerId !== this.playerId) return;

    switch (data.type) {
      case 'update_xp':
        this.updateXPFromAdmin(data.newXP);
        break;
      case 'add_credits':
        this.addCreditsFromAdmin(data.amount);
        break;
      case 'recharge_energy':
        this.rechargeEnergyFromAdmin(data.amount);
        break;
      case 'force_refresh':
        this.forceRefresh();
        break;
    }
  }

  handleAdminCommand(command) {
    if (command.playerId && command.playerId !== this.playerId) return;
    this.handleAdminMessage(command);
  }

  updateXPFromAdmin(newXP) {
    if (typeof gameStateManager !== 'undefined' && gameStateManager.addXP) {
      const currentXP = parseInt(localStorage.getItem('playerXP')) || 0;
      const difference = newXP - currentXP;
      if (difference > 0) {
        gameStateManager.addXP(difference);
      } else {
        localStorage.setItem('playerXP', newXP.toString());
      }
    } else {
      localStorage.setItem('playerXP', newXP.toString());
    }
    
    this.updateStats();
    this.showAdminNotification(`XP updated to ${newXP} by admin`);
  }

  addCreditsFromAdmin(amount) {
    if (typeof gameStateManager !== 'undefined' && gameStateManager.addCredits) {
      gameStateManager.addCredits(amount);
    } else {
      const currentCredits = parseFloat(localStorage.getItem('walletBalance')) || 0;
      localStorage.setItem('walletBalance', (currentCredits + amount).toString());
    }
    
    this.updateStats();
    this.showAdminNotification(`Received ${amount} credits from admin`);
  }

  rechargeEnergyFromAdmin(amount) {
    if (typeof gameStateManager !== 'undefined' && gameStateManager.rechargeEnergy) {
      gameStateManager.rechargeEnergy(amount);
    }
    
    this.updateStats();
    this.showAdminNotification(`Energy recharged by ${amount}% by admin`);
  }

  forceRefresh() {
    this.updateStats();
    if (typeof updateStatusDisplay === 'function') {
      updateStatusDisplay();
    }
    this.showAdminNotification('Game state refreshed by admin');
  }

  showAdminNotification(message) {
    // Show notification in game if addToHistory function exists
    if (typeof addToHistory === 'function') {
      addToHistory(`ðŸ›¡ï¸ Admin: ${message}`, false, 'system');
    } else {
      console.log(`[Admin] ${message}`);
    }
  }

  syncWithAdmin(eventType, data) {
    const adminEvent = {
      timestamp: new Date().toISOString(),
      type: eventType,
      playerId: this.playerId,
      playerName: this.playerProfile?.name,
      data: data
    };

    // Send via BroadcastChannel
    if (this.adminChannel) {
      this.adminChannel.postMessage(adminEvent);
    }

    // Store in admin log
    const adminLog = JSON.parse(localStorage.getItem('marsoverse_admin_log') || '[]');
    adminLog.push(adminEvent);
    
    // Keep only last 100 events
    if (adminLog.length > 100) {
      adminLog.splice(0, adminLog.length - 100);
    }
    
    localStorage.setItem('marsoverse_admin_log', JSON.stringify(adminLog));
  }

  startPeriodicSync() {
    // Update stats every 30 seconds
    setInterval(() => {
      this.updateStats();
    }, 30000);

    // Send heartbeat every 60 seconds
    setInterval(() => {
      this.syncWithAdmin('heartbeat', {
        timestamp: new Date().toISOString(),
        gameState: typeof gameState !== 'undefined' ? gameState : null
      });
    }, 60000);
  }

  // Method to go offline when leaving
  goOffline() {
    if (this.playerProfile) {
      this.playerProfile.status = 'offline';
      this.playerProfile.lastActive = new Date().toISOString();
      this.addToAdminSystem(this.playerProfile);
      
      this.syncWithAdmin('player_logout', {
        playerId: this.playerId,
        timestamp: new Date().toISOString()
      });
    }
  }
}

// Enhanced Solana Pay Manager with Admin Integration
class EnhancedSolanaPayManager {
  constructor() {
    this.playerManager = null;
    this.connection = null;
    this.network = 'devnet'; // or 'mainnet-beta'
    
    this.packs = {
      small: { name: 'Energy Boost', price: 0.01, energy: 25, credits: 0 },
      medium: { name: 'Resource Pack', price: 0.05, energy: 50, credits: 500 },
      large: { name: 'Premium Bundle', price: 0.1, energy: 100, credits: 1000 }
    };
  }

  setPlayerManager(playerManager) {
    this.playerManager = playerManager;
  }

  async processPurchase(packType) {
    if (!this.playerManager) {
      throw new Error('Player manager not initialized');
    }

    const pack = this.packs[packType];
    if (!pack) {
      throw new Error('Invalid pack type');
    }

    try {
      // Log purchase attempt
      this.playerManager.syncWithAdmin('purchase_attempted', {
        packType,
        pack,
        timestamp: new Date().toISOString()
      });

      // Create payment reference
      const reference = new Uint8Array(32);
      crypto.getRandomValues(reference);
      const referenceBase58 = this.uint8ArrayToBase58(reference);

      // Show payment modal
      this.showPaymentModal(pack, referenceBase58, packType);

      // For demo purposes, simulate successful payment after 5 seconds
      // In production, you'd implement actual Solana Pay verification
      setTimeout(() => {
        this.processSuccessfulPayment(pack, packType, referenceBase58);
      }, 5000);

    } catch (error) {
      console.error('Purchase error:', error);
      throw error;
    }
  }

  showPaymentModal(pack, reference, packType) {
    const modal = document.createElement('div');
    modal.className = 'popup-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="popup">
        <h3><i class="fas fa-shopping-cart"></i> Purchase ${pack.name}</h3>
        <p>Price: ${pack.price} SOL</p>
        <p>Player: ${this.playerManager?.playerProfile?.name || 'Anonymous'}</p>
        <p>You will receive:</p>
        <ul style="text-align: left; margin: 1rem 0;">
          ${pack.energy > 0 ? `<li>âš¡ ${pack.energy}% Energy</li>` : ''}
          ${pack.credits > 0 ? `<li>ðŸ’° ${pack.credits} Credits</li>` : ''}
        </ul>
        <div style="text-align: center; margin: 1rem 0;">
          <div style="background: #333; padding: 1rem; border-radius: 8px;">
            <i class="fas fa-clock"></i> Simulating payment... <br>
            <small>In production, you'd scan QR code or use Phantom wallet</small>
          </div>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn secondary" onclick="this.closest('.popup-overlay').remove()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 1rem;">
          Reference: ${reference.slice(0, 8)}...
        </p>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  processSuccessfulPayment(pack, packType, reference) {
    // Apply pack benefits
    if (pack.energy > 0 && typeof gameStateManager !== 'undefined') {
      gameStateManager.rechargeEnergy(pack.energy);
    }
    if (pack.credits > 0 && typeof gameStateManager !== 'undefined') {
      gameStateManager.addCredits(pack.credits);
    }

    // Log purchase
    if (this.playerManager) {
      this.playerManager.logPurchase(packType, pack.price, reference);
    }

    // Close modal and show success
    document.querySelectorAll('.popup-overlay').forEach(modal => modal.remove());
    
    if (typeof addToHistory === 'function') {
      addToHistory(`âœ… Purchase successful! Received ${pack.name}`, false, 'system');
    }

    // Update admin
    if (this.playerManager) {
      this.playerManager.syncWithAdmin('purchase_completed', {
        packType,
        pack,
        reference,
        timestamp: new Date().toISOString()
      });
    }
  }

  uint8ArrayToBase58(uint8Array) {
    // Simple base58 encoding for reference
    return btoa(String.fromCharCode.apply(null, uint8Array)).replace(/[^A-Za-z0-9]/g, '').slice(0, 16);
  }
}

// Global initialization
let marsoVersePlayerManager, enhancedSolanaPayManager;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize player management
  marsoVersePlayerManager = new MarsoVersePlayerManager();
  
  // Initialize enhanced Solana Pay
  enhancedSolanaPayManager = new EnhancedSolanaPayManager();
  enhancedSolanaPayManager.setPlayerManager(marsoVersePlayerManager);
  
  // Make available globally
  window.marsoVersePlayerManager = marsoVersePlayerManager;
  window.enhancedSolanaPayManager = enhancedSolanaPayManager;
  
  console.log('MarsoVerse Admin Integration initialized');
});

// Handle page unload
window.addEventListener('beforeunload', function() {
  if (marsoVersePlayerManager) {
    marsoVersePlayerManager.goOffline();
  }
});

// Enhanced purchase function
async function purchasePack(packType) {
  try {
    document.querySelectorAll('.popup-overlay').forEach(modal => modal.remove());
    
    if (typeof addToHistory === 'function') {
      addToHistory(`ðŸ›’ Initiating purchase for ${enhancedSolanaPayManager.packs[packType].name}...`, false, 'system');
    }
    
    await enhancedSolanaPayManager.processPurchase(packType);
  } catch (error) {
    if (typeof addToHistory === 'function') {
      addToHistory('âŒ Purchase failed. Please try again.', false, 'system');
    }
    console.error('Purchase error:', error);
  }
}
  </script>
  <script>
    // Real Solana Pay Integration
class RealSolanaPayManager {
  constructor() {
    this.connection = new Connection('https://api.devnet.solana.com', 'confirmed');
    this.packs = {
      small: { name: 'Energy Boost', price: 0.01, energy: 25, credits: 100 },
      medium: { name: 'Resource Pack', price: 0.05, energy: 50, credits: 500 },
      large: { name: 'Premium Bundle', price: 0.1, energy: 100, credits: 1000 }
    };
  }

  async createPayment(packType) {
    const pack = this.packs[packType];
    const recipientWallet = 'YourRecipientWalletAddressHere'; // Replace with your wallet
    
    const paymentUrl = `solana:${recipientWallet}?amount=${pack.price}&label=${encodeURIComponent(pack.name)}&message=${encodeURIComponent(`Purchase ${pack.name} for MarsoVerse`)}`;
    
    // Generate QR code for payment
    this.showPaymentQR(paymentUrl, pack, packType);
    
    // Start monitoring for payment
    this.monitorPayment(recipientWallet, pack.price, packType);
  }

  showPaymentQR(paymentUrl, pack, packType) {
    const modal = document.createElement('div');
    modal.className = 'popup-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="popup" style="max-width: 400px;">
        <h3><i class="fas fa-wallet"></i> Pay with Solana</h3>
        <div style="text-align: center; margin: 1rem 0;">
          <div id="qr-code" style="background: white; padding: 20px; border-radius: 10px; margin: 10px auto; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;">
            <div style="font-size: 12px; color: black;">
              Open Phantom/Solflare wallet<br>
              Scan QR or use link below
            </div>
          </div>
          <button onclick="window.open('${paymentUrl}', '_blank')" class="popup-btn primary" style="margin: 10px;">
            Open Wallet
          </button>
        </div>
        <p style="font-size: 0.9rem;">
          <strong>${pack.name}</strong><br>
          Price: ${pack.price} SOL<br>
          You'll receive: ${pack.energy}% energy, ${pack.credits} credits
        </p>
        <div class="popup-buttons">
          <button class="popup-btn secondary" onclick="this.closest('.popup-overlay').remove()">
            Cancel
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  async monitorPayment(wallet, expectedAmount, packType) {
    // In production, implement proper payment verification
    // For now, simulate after 10 seconds
    setTimeout(() => {
      this.processPayment(packType);
    }, 10000);
  }

  processPayment(packType) {
    const pack = this.packs[packType];
    
    // Apply benefits
    gameState.resources.energy = Math.min(100, gameState.resources.energy + pack.energy);
    gameState.resources.credits += pack.credits;
    
    // Log to server
    this.logPurchaseToServer(packType, pack);
    
    // Close modal
    document.querySelectorAll('.popup-overlay').forEach(m => m.remove());
    
    addToHistory(`âœ… Payment successful! Received ${pack.name}`, false, 'system');
    addXP(pack.credits / 10);
    saveGame();
  }

  async logPurchaseToServer(packType, pack) {
    try {
      await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'purchase',
          data: { packType, pack, timestamp: new Date().toISOString() },
          game: 'zepta_terminal',
          playerId: marsoVersePlayerManager?.playerId || 'anonymous',
          walletAddress: localStorage.getItem('walletAddress') || null
        })
      });
    } catch (error) {
      console.error('Failed to log purchase:', error);
    }
  }
}
window.sendApology = sendApology;
window.giveGift = giveGift;
// Initialize Solana Pay
const realSolanaPayManager = new RealSolanaPayManager();
  </script>
</body>
</html>